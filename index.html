<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ATK Request Form - BPS South Jakarta</title>

  <!-- GHPAGES base: sesuaikan jika repo-nya di subpath -->
  <base href="/buildp/">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- SheetJS for .xlsx export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>



  <style>
    body { box-sizing: border-box; }
    @media print { .no-print { display:none!important } }
    .toast{position:fixed;top:20px;right:20px;background:#10b981;color:#fff;padding:12px 18px;border-radius:8px;z-index:1000}
    .toast.error{background:#ef4444}
    .modal-backdrop{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:999}
    .modal-content{background:#fff;border-radius:12px;padding:24px;max-width:600px;width:92%}
    .digital-signature{border:2px solid #10b981;background:#f0fdf4;padding:16px;border-radius:8px;font-family:'Courier New',monospace}
  </style>
</head>
<body class="bg-gray-50 min-h-full">
  <div id="app" class="max-w-6xl mx-auto p-4 md:p-8"></div>

  <script>
  // ---------- MAIN APP (UI + logic) ----------
  document.addEventListener('DOMContentLoaded', () => {
    // Default config (fallback)
    const defaultConfig = {
      form_title: "Form Permintaan ATK",
      budget_year: (new Date()).getFullYear().toString(),
      organization_name: "BPS Kota Jakarta Selatan",
      logo_url: "https://upload.wikimedia.org/wikipedia/commons/thumb/2/28/Lambang_Badan_Pusat_Statistik_%28BPS%29_Indonesia.svg/1160px-Lambang_Badan_Pusat_Statistik_%28BPS%29_Indonesia.svg.png",
      doc_number_format: "0001",
      whatsapp_number: "",
      submit_button_text: "Kirim Permintaan"
    };

    // App state
    let appSettings = null;         // loaded from sheet (settings record) or localStorage fallback
    let currentRequests = [];       // loaded from sheet or local demo
    let currentView = 'form';
    let editingRequestId = null;

    // Utility: toast
    function showToast(msg, isError=false){
      const t=document.createElement('div'); t.className='toast' + (isError? ' error':'' ); t.textContent=msg; document.body.appendChild(t);
      setTimeout(()=>t.remove(),3500);
    }

    function formatDate(dateString){
      if(!dateString) return '-';
      const d=new Date(dateString);
      const months=['January','February','March','April','May','June','July','August','September','October','November','December'];
      return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
    }
    function formatTimestamp(iso){ if(!iso) return '-'; const d=new Date(iso); return d.toLocaleString('en-US',{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}); }

    // Data SDK (if adapter available)
    function ensureDataSdk(){ return window.dataSdk || null; }

    // ------------------ BUILD UI ------------------
    const app = document.getElementById('app');
    app.innerHTML = `
      <div class="no-print mb-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-3">
        <button id="newRequestBtn" class="px-4 py-3 bg-blue-600 text-white rounded-lg">üìù Permintaan Baru</button>
        <button id="viewRequestsBtn" class="px-4 py-3 bg-gray-600 text-white rounded-lg">üìã Semua Permintaan</button>
        <button id="verifierViewBtn" class="px-4 py-3 bg-orange-600 text-white rounded-lg">‚úÖ Verifikator</button>
        <button id="supervisorViewBtn" class="px-4 py-3 bg-purple-600 text-white rounded-lg">üëî Penanggung Jawab</button>
        <button id="settingsBtn" class="px-4 py-3 bg-gray-700 text-white rounded-lg">‚öôÔ∏è Pengaturan</button>
        <button id="exportExcelBtnTop" class="px-4 py-3 bg-indigo-600 text-white rounded-lg">üì• Export Excel</button>
      </div>

      <div id="requestFormView" class="bg-white rounded-lg shadow-lg p-6 md:p-8 print-section"></div>

      <div id="allRequestsView" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl font-bold">Semua Permintaan ATK</h2>
            <div class="flex gap-2 items-center">
              <label class="text-sm">Bulan</label>
              <select id="filterMonth" class="px-2 py-2 border rounded"></select>
              <label class="text-sm">Tahun</label>
              <select id="filterYear" class="px-2 py-2 border rounded"></select>
              <button id="exportFilteredBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">üì• Export Excel</button>
            </div>
          </div>
          <div id="allRequestsList" class="space-y-4 mt-4"></div>
        </div>
      </div>

      <div id="verifierView" class="hidden"><div class="bg-white rounded-lg shadow-lg p-6"><h2 class="text-2xl font-bold">Dashboard Verifikator</h2><div id="verifierRequestsList" class="space-y-4 mt-4"></div></div></div>
      <div id="supervisorView" class="hidden"><div class="bg-white rounded-lg shadow-lg p-6"><h2 class="text-2xl font-bold">Dashboard Penanggung Jawab</h2><div id="supervisorRequestsList" class="space-y-4 mt-4"></div></div></div>

      <div id="requestDetailView" class="hidden bg-white rounded-lg shadow-lg p-6 md:p-8 print-section"></div>

      <div id="settingsView" class="hidden bg-white rounded-lg shadow-lg p-6 md:p-8"></div>
    `;

    // ------------------ Form renderer ------------------
    function renderFormView(){
      const settings = getCurrentSettings();
      const v = document.getElementById('requestFormView');
      v.innerHTML = `
        <div class="mb-8 border-b-2 border-gray-800 pb-6">
          <div class="flex items-center justify-center gap-6">
            <div class="flex-shrink-0 logo-container">${getLogoHTML(settings.logo_url)}</div>
            <div class="text-center flex-grow">
              <h1 id="formTitle" class="text-3xl font-bold text-gray-800 mb-2">${escapeHtml(settings.form_title)}</h1>
              <p id="budgetYear" class="text-gray-700 text-lg mb-1">Tahun Anggaran ${escapeHtml(settings.budget_year)}</p>
              <p id="organizationName" class="text-gray-600">${escapeHtml(settings.organization_name)}</p>
            </div>
            <div class="flex-shrink-0 w-20"></div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div><label class="block text-sm font-semibold">No Dokumen</label><input id="documentNumber" readonly class="w-full px-4 py-2 border rounded bg-gray-100"></div>
          <div><label class="block text-sm font-semibold">Tahun</label><select id="yearSelect" class="w-full px-4 py-2 border rounded"></select></div>
          <div><label class="block text-sm font-semibold">Bagian/Fungsi</label><select id="workUnitSelect" class="w-full px-4 py-2 border rounded"><option value=''>Pilih Bagian/Fungsi</option><option value='Subbagian Umum'>Subbagian Umum</option></select></div>
        </div>

        <div class="mb-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">Rincian ATK</h2>
            <button id="addRowBtn" class="no-print px-4 py-2 bg-green-600 text-white rounded-lg">+ Tambah Item</button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full border-collapse border border-gray-300">
              <thead><tr class="bg-gray-100"><th class="px-4 py-3 w-12">No</th><th class="px-4 py-3">Nama Item</th><th class="px-4 py-3 w-32">Jumlah</th><th class="px-4 py-3">Satuan</th><th class="px-4 py-3 w-24 no-print">Aksi</th></tr></thead>
              <tbody id="itemsTableBody"></tbody>
            </table>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div><label class="block text-sm font-semibold">Lokasi Pengajuan</label><input id="submissionLocation" class="w-full px-4 py-2 border rounded" value="Jakarta"></div>
          <div><label class="block text-sm font-semibold">Tanggal Pengajuan</label><input id="submissionDate" type="date" class="w-full px-4 py-2 border rounded"></div>
        </div>

        <div class="border-t-2 border-gray-200 pt-6 mb-6">
          <h2 class="text-xl font-bold mb-4">Informasi Pemohon</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div><label class="block text-sm font-semibold">Nama</label><input id="requesterName" class="w-full px-4 py-2 border rounded"></div>
            <div><label class="block text-sm font-semibold">NIP</label><input id="requesterNIP" class="w-full px-4 py-2 border rounded" placeholder="contoh: 199012345678901234"></div>
          </div>
          <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg"><p class="text-sm text-blue-800"><strong>‚ÑπÔ∏è Tanda Tangan Digital:</strong> Permintaan Anda akan ditandatangani secara digital.</p></div>
          <button id="submitRequestBtn" class="no-print w-full px-6 py-3 bg-blue-600 text-white rounded-lg font-bold text-lg">${escapeHtml(defaultConfig.submit_button_text)}</button>
        </div>
      `;

      initYearDropdown();
      initSubmissionDate();
      updateDocumentNumber();
      addItemRow();

      document.getElementById('addRowBtn').addEventListener('click', addItemRow);
      document.getElementById('submitRequestBtn').addEventListener('click', submitRequest);
    }

    // ------------------ helper & form functions ------------------
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, (m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'})[m]);}

    function initYearDropdown(){
      const sel=document.getElementById('yearSelect');
      sel.innerHTML='';
      const currentYear=(new Date()).getFullYear();
      for(let i=currentYear-5;i<=currentYear+5;i++){
        const o=document.createElement('option'); o.value=i; o.textContent=i; if(i===currentYear) o.selected=true; sel.appendChild(o);
      }
    }
    function initSubmissionDate(){ const d=document.getElementById('submissionDate'); d.value=(new Date()).toISOString().split('T')[0]; }

    function addItemRow(){
      const tbody=document.getElementById('itemsTableBody');
      const row=document.createElement('tr');
      const idx=tbody.children.length+1;
      row.innerHTML=`
        <td class="border px-4 py-2 text-center">${idx}</td>
        <td class="border px-4 py-2"><input type="text" class="item-name w-full px-2 py-1 border rounded" placeholder="Masukkan nama item"></td>
        <td class="border px-4 py-2"><input type="number" class="item-quantity w-full px-2 py-1 border rounded" min="1" value="1"></td>
        <td class="border px-4 py-2"><input type="text" class="item-notes w-full px-2 py-1 border rounded" placeholder="Satuan (contoh: pcs)"></td>
        <td class="border px-4 py-2 text-center no-print"><button class="delete-row-btn px-3 py-1 bg-red-500 text-white rounded">Hapus</button></td>
      `;
      tbody.appendChild(row);
      row.querySelector('.delete-row-btn').addEventListener('click', ()=>{
        row.remove();
        updateRowNumbers();
      });
    }
    function updateRowNumbers(){ const tbody=document.getElementById('itemsTableBody'); Array.from(tbody.children).forEach((r,i)=> r.children[0].textContent=i+1); }
    function getItemsFromTable(){ const tbody=document.getElementById('itemsTableBody'); const items=[]; Array.from(tbody.children).forEach(row=>{ const name=row.querySelector('.item-name').value.trim(); const qty=parseInt(row.querySelector('.item-quantity').value) || 0; const notes=row.querySelector('.item-notes').value.trim(); if(name && qty>0) items.push({name,quantity:qty,notes}); }); return items; }

    // Document number generator
    function updateDocumentNumber(){ const el=document.getElementById('documentNumber'); if(el) el.value = generateDocumentNumber(); }
    function generateDocumentNumber(){
      const year=document.getElementById('yearSelect').value;
      const submissionDate=document.getElementById('submissionDate').value;
      const settings = getCurrentSettings();
      const prefix = settings.doc_number_format || defaultConfig.doc_number_format;
      let month = '01';
      if(submissionDate){ const d=new Date(submissionDate); month=(d.getMonth()+1).toString().padStart(2,'0'); }
      const existingNumbers = (currentRequests||[]).filter(r=>r.recordType==='request').filter(r=>{
        const parts=(r.documentNumber||'').split('/');
        return parts.length===4 && parts[2]===month && parts[3]===year;
      }).map(r=>{ const parts=(r.documentNumber||'').split('/'); return parseInt(parts[0])||0; });
      const nextNumber = existingNumbers.length>0? Math.max(...existingNumbers)+1 : parseInt(prefix) || 1;
      const padded = nextNumber.toString().padStart(4,'0');
      return `${padded}/ATK/${month}/${year}`;
    }

    // Validate & submit
    function validateForm(){
      const year=document.getElementById('yearSelect').value;
      const workUnit=document.getElementById('workUnitSelect').value;
      const items=getItemsFromTable();
      const requesterName=document.getElementById('requesterName').value.trim();
      const requesterNIP=document.getElementById('requesterNIP').value.trim();
      if(!year){ showToast('Mohon pilih tahun', true); return false; }
      if(!workUnit){ showToast('Mohon pilih bagian/fungsi', true); return false; }
      if(items.length===0){ showToast('Mohon tambahkan minimal satu item', true); return false; }
      if(!requesterName){ showToast('Mohon isi nama pemohon', true); return false; }
      if(!requesterNIP){ showToast('Mohon isi NIP pemohon', true); return false; }
      return true;
    }

    async function submitRequest(){
      if(!validateForm()) return;
      const btn=document.getElementById('submitRequestBtn');
      btn.disabled=true; btn.textContent='Mengirim...';
      try{
        const documentNumber = generateDocumentNumber();
        const year=document.getElementById('yearSelect').value;
        const workUnit=document.getElementById('workUnitSelect').value;
        const items=getItemsFromTable();
        const submissionDate=document.getElementById('submissionDate').value;
        const submissionLocation=document.getElementById('submissionLocation').value.trim();
        const requesterName=document.getElementById('requesterName').value.trim();
        const requesterNIP=document.getElementById('requesterNIP').value.trim();

        const record = {
          recordType: 'request',
          documentNumber,
          year,
          workUnit,
          items: JSON.stringify(items),
          submissionDate,
          submissionLocation,
          requesterName,
          requesterNIP,
          status: 'Pending Verification',
          verifierName: '',
          verifierNIP: '',
          verificationDate: '',
          supervisorName: '',
          supervisorNIP: '',
          supervisorApprovalDate: '',
          rejectionReason: '',
          rejectedBy: '',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };

        const sdk = ensureDataSdk();
        if(sdk && sdk.create){
          const res = await sdk.create(record);
          if(res && res.isOk){ showToast('Permintaan berhasil dikirim dan tersimpan!'); resetForm(); }
          else { console.error('create failed', res); showToast('Gagal menyimpan: ' + (res && res.error && res.error.message ? res.error.message : 'Unknown'), true); }
        } else {
          // fallback local
          record.__backendId = 'local-'+Math.random().toString(36).slice(2,9);
          currentRequests.push(record);
          showToast('Disimpan lokal (SDK belum terhubung).');
          resetForm();
        }
      }catch(e){ console.error(e); showToast('Gagal mengirim: '+e.message,true); }
      finally{ btn.disabled=false; btn.textContent=getCurrentSettings().submit_button_text; }
    }

    function resetForm(){
      document.getElementById('workUnitSelect').value='';
      document.getElementById('itemsTableBody').innerHTML='';
      document.getElementById('requesterName').value='';
      document.getElementById('requesterNIP').value='';
      initSubmissionDate(); updateDocumentNumber(); addItemRow();
    }

    // ------------------ Settings UI (simplified, removed Google fields) ------------------
    function getCurrentSettings(){
      if(appSettings){
        return {
          form_title: appSettings.form_title || defaultConfig.form_title,
          budget_year: appSettings.budget_year || defaultConfig.budget_year,
          organization_name: appSettings.organization_name || defaultConfig.organization_name,
          doc_number_format: appSettings.doc_number_format || defaultConfig.doc_number_format,
          logo_url: appSettings.logo_url || defaultConfig.logo_url,
          whatsapp_number: appSettings.whatsapp_number || defaultConfig.whatsapp_number,
          submit_button_text: appSettings.submit_button_text || defaultConfig.submit_button_text
        };
      }
      // fallback: read from localStorage
      return {
        form_title: localStorage.getItem('atk_form_title') || defaultConfig.form_title,
        budget_year: localStorage.getItem('atk_budget_year') || defaultConfig.budget_year,
        organization_name: localStorage.getItem('atk_org') || defaultConfig.organization_name,
        doc_number_format: localStorage.getItem('atk_doc_prefix') || defaultConfig.doc_number_format,
        logo_url: localStorage.getItem('atk_logo') || defaultConfig.logo_url,
        whatsapp_number: localStorage.getItem('atk_whatsapp_number') || defaultConfig.whatsapp_number,
        submit_button_text: defaultConfig.submit_button_text
      };
    }

    function applySettingsToUI(){
      const s=getCurrentSettings();
      document.querySelectorAll('.logo-container').forEach(el => el.innerHTML = getLogoHTML(s.logo_url));
      const submitBtn = document.getElementById('submitRequestBtn');
      if(submitBtn) submitBtn.textContent = s.submit_button_text;
    }

    function getLogoHTML(logoUrl){
      if(logoUrl && logoUrl.trim()!=='') return `<img src="${escapeHtml(logoUrl)}" alt="Logo" class="w-20 h-20 object-contain" onerror="this.style.display='none'">`;
      return `<svg width="80" height="80" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M50 5 L85 20 L85 50 Q85 75 50 95 Q15 75 15 50 L15 20 Z" fill="#1e40af"/><path d="M50 15 L75 25 L75 50 Q75 70 50 85 Q25 70 25 50 L25 25 Z" fill="#3b82f6"/><text x="50" y="45" font-family="Arial" font-size="16" font-weight="bold" fill="white" text-anchor="middle">BPS</text></svg>`;
    }

    // ------------------ Render lists & detail ------------------
    function renderAllRequests(){
      const container=document.getElementById('allRequestsList');
      const requests = (currentRequests||[]).filter(r=>r.recordType==='request');
      if(requests.length===0){ container.innerHTML='<p class="text-gray-500 text-center py-8">Belum ada permintaan</p>'; return; }
      const sorted = requests.slice().sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
      container.innerHTML = '';
      sorted.forEach(r=>{
        const card=document.createElement('div'); card.className='border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow';
        const statusBadge = `<span class="px-3 py-1 rounded-full text-sm font-semibold ${getStatusColor(r.status)}">${r.status}</span>`;
        card.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <div class="flex-1 cursor-pointer">
              <h3 class="font-bold text-lg text-gray-800">${escapeHtml(r.documentNumber)}</h3>
              <p class="text-sm text-gray-600">${escapeHtml(r.workUnit)} - ${escapeHtml(r.year)}</p>
            </div>
            <div class="flex gap-2 items-start">
              ${statusBadge}
              <button class="open-wa px-3 py-1 bg-green-500 text-white rounded-lg">üì± Buka WA</button>
              <button class="delete-req px-3 py-1 bg-red-500 text-white rounded-lg">üóëÔ∏è Hapus</button>
            </div>
          </div>
          <div class="cursor-pointer view-detail">
            <p class="text-sm text-gray-700 mb-2"><strong>Requester:</strong> ${escapeHtml(r.requesterName)} (${escapeHtml(r.requesterNIP)})</p>
            <p class="text-sm text-gray-600"><strong>Date:</strong> ${formatDate(r.submissionDate)}</p>
          </div>
        `;
        // events
        card.querySelector('.view-detail').addEventListener('click', ()=> window.viewRequestDetail(r.__backendId || r.documentNumber));
        card.querySelector('.open-wa').addEventListener('click', ()=> openWhatsApp(r.__backendId || r.documentNumber));
        card.querySelector('.delete-req').addEventListener('click', async (ev)=> {
          ev.stopPropagation();
          if(!confirm('Yakin ingin menghapus permintaan ini?')) return;
          const sdk = ensureDataSdk();
          if(sdk && sdk.delete){
            const result = await sdk.delete(r);
            if(result && result.isOk){ showToast('Permintaan berhasil dihapus'); }
            else { showToast('Gagal menghapus', true); console.error('delete error', result); }
          } else {
            // fallback remove local
            currentRequests = currentRequests.filter(x => (x.__backendId || x.documentNumber) !== (r.__backendId || r.documentNumber));
            renderAllRequests();
            showToast('Dihapus (local)');
          }
        });
        container.appendChild(card);
      });
    }

    function getStatusColor(status){
      switch(status){
        case 'Pending Verification': return 'bg-yellow-200 text-yellow-800';
        case 'Verified - Pending Approval': return 'bg-blue-200 text-blue-800';
        case 'Fully Approved': return 'bg-green-200 text-green-800';
        case 'Rejected by Verifier': case 'Rejected by Supervisor': return 'bg-red-200 text-red-800';
        default: return 'bg-gray-200 text-gray-800';
      }
    }

    window.viewRequestDetail = function(id){
      const req = currentRequests.find(r=> (r.__backendId && r.__backendId===id) || (r.documentNumber && r.documentNumber===id));
      if(!req){ showToast('Request not found', true); return; }
      editingRequestId = req.__backendId || req.documentNumber;
      const dv = document.getElementById('requestDetailView');
      dv.innerHTML = `
        <div class="no-print mb-4">
          <button onclick="window.switchView('requests')" class="px-4 py-2 bg-gray-500 text-white rounded">‚Üê Back</button>
          <button onclick="window.printDocument && window.printDocument()" class="ml-2 px-4 py-2 bg-blue-500 text-white rounded">üñ®Ô∏è Export PDF</button>
        </div>
        <div class="mb-8 border-b-2 border-gray-800 pb-6">
          <div class="flex items-center gap-6">
            ${getLogoHTML(getCurrentSettings().logo_url)}
            <div>
              <h1 class="text-3xl font-bold">${escapeHtml(getCurrentSettings().form_title)}</h1>
              <p>Tahun Anggaran ${escapeHtml(getCurrentSettings().budget_year)}</p>
              <p>${escapeHtml(getCurrentSettings().organization_name)}</p>
            </div>
          </div>
        </div>
        <div>
          <p><strong>Document Number:</strong> ${escapeHtml(req.documentNumber)}</p>
          <p><strong>Submission:</strong> ${escapeHtml(req.submissionLocation)}, ${formatDate(req.submissionDate)}</p>
          <p><strong>Status:</strong> <span class="px-3 py-1 rounded-full ${getStatusColor(req.status)}">${escapeHtml(req.status)}</span></p>
        </div>
        <div class="mb-6 mt-4">
          <h2 class="text-xl font-bold">ATK Items</h2>
          <table class="w-full border-collapse border border-gray-300">
            <thead class="bg-gray-100"><tr><th>No</th><th>Item</th><th>Qty</th><th>Notes</th></tr></thead>
            <tbody>
              ${JSON.parse(req.items).map((it,i)=>`<tr><td class="border px-3">${i+1}</td><td class="border px-3">${escapeHtml(it.name)}</td><td class="border px-3">${escapeHtml(String(it.quantity))}</td><td class="border px-3">${escapeHtml(it.notes||'-')}</td></tr>`).join('')}
            </tbody>
          </table>
        </div>
        <div class="digital-signature">
          <p class="text-green-700 font-semibold mb-1">‚úì DIGITALLY SIGNED</p>
          <p class="text-gray-800"><strong>Signed by:</strong> ${escapeHtml(req.requesterName)}</p>
          <p class="text-gray-700"><strong>NIP:</strong> ${escapeHtml(req.requesterNIP)}</p>
          <p class="text-gray-600 text-sm"><strong>Date:</strong> ${formatDate(req.submissionDate)}</p>
          <p class="text-gray-600 text-sm"><strong>Timestamp:</strong> ${formatTimestamp(req.createdAt)}</p>
        </div>
      `;
      window.switchView('detail');
    };

    // ------------------ WhatsApp helper ------------------
    function getWhatsAppUrl(requestId){
      const req = currentRequests.find(r=> (r.__backendId && r.__backendId===requestId) || (r.documentNumber && r.documentNumber===requestId));
      if(!req) return null;
      const settings = getCurrentSettings();
      const phone = localStorage.getItem('atk_whatsapp_number') || settings.whatsapp_number || '';
      if(!phone) return null;
      const items = JSON.parse(req.items);
      const itemsList = items.map((it,idx)=> `${idx+1}. ${it.name} (${it.quantity})`).join('%0A');
      let message = `*Pengingat Permintaan ATK*%0A%0A`;
      message += `*Dokumen:* ${req.documentNumber}%0A`;
      message += `*Status:* ${req.status}%0A`;
      message += `*Bagian/Fungsi:* ${req.workUnit}%0A`;
      message += `*Tahun:* ${req.year}%0A%0A`;
      message += `*Pemohon:*%0ANama: ${req.requesterName}%0A NIP: ${req.requesterNIP}%0A%0A`;
      message += `*Item yang Diminta:*%0A${itemsList}%0A%0A`;
      message += `*Tanggal Pengajuan:* ${formatDate(req.submissionDate)}%0A`;
      message += `*Lokasi:* ${req.submissionLocation}%0A%0A`;
      if(req.status==='Pending Verification') message += `‚ö†Ô∏è Permintaan ini menunggu verifikasi. Mohon tinjau dan verifikasi.`;
      else if(req.status==='Verified - Pending Approval') message += `‚ö†Ô∏è Permintaan ini menunggu persetujuan akhir.`;
      else if(req.status==='Fully Approved') message += `‚úÖ Permintaan ini telah disetujui.`;
      return `https://wa.me/${phone}?text=${message}`;
    }
    function openWhatsApp(requestId){
      const url = getWhatsAppUrl(requestId);
      if(!url){ showToast('Nomor WhatsApp belum diatur di Settings', true); return; }
      window.open(url, '_blank', 'noopener');
    }

    // ------------------ Settings UI (removed Google fields) ------------------
    function loadSettingsForm(){
      const s = getCurrentSettings();
      const v = document.getElementById('settingsView');
      v.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Settings / Pengaturan</h2>
        <div class="mb-4"><label class="block text-sm font-semibold mb-1">Form Title</label><input id="settingFormTitle" class="w-full px-3 py-2 border rounded" value="${escapeHtml(s.form_title)}"></div>
        <div class="mb-4"><label class="block text-sm font-semibold mb-1">Budget Year</label><input id="settingBudgetYear" class="w-full px-3 py-2 border rounded" value="${escapeHtml(s.budget_year)}"></div>
        <div class="mb-4"><label class="block text-sm font-semibold mb-1">Organization Name</label><input id="settingOrganizationName" class="w-full px-3 py-2 border rounded" value="${escapeHtml(s.organization_name)}"></div>
        <div class="mb-4"><label class="block text-sm font-semibold mb-1">Document Number Prefix</label><input id="settingDocNumberFormat" class="w-full px-3 py-2 border rounded" value="${escapeHtml(localStorage.getItem('atk_doc_prefix') || s.doc_number_format)}"><p class="text-xs text-gray-500 mt-1">Contoh: 0001 -> 0001/ATK/MM/YYYY</p></div>
        <div class="mb-4"><label class="block text-sm font-semibold mb-1">Logo URL</label><input id="settingLogoUrl" class="w-full px-3 py-2 border rounded" value="${escapeHtml(s.logo_url)}"></div>
        <div class="mb-4"><label class="block text-sm font-semibold mb-1">WhatsApp Number (contoh: 628123...)</label><input id="settingWhatsAppNumber" class="w-full px-3 py-2 border rounded" value="${escapeHtml(localStorage.getItem('atk_whatsapp_number') || s.whatsapp_number || '')}"></div>

        <div class="flex gap-4 mt-4">
          <button id="saveSettingsBtn" class="px-4 py-2 bg-green-600 text-white rounded">üíæ Save Settings</button>
          <button id="cancelSettingsBtn" class="px-4 py-2 bg-gray-500 text-white rounded">Cancel</button>
        </div>
        <p class="text-xs text-gray-500 mt-3">Note: Google Client ID and Spreadsheet settings have been removed ‚Äî the app will work in local/demo mode unless adapter is initialized separately.</p>
      `;
      document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
      document.getElementById('cancelSettingsBtn').addEventListener('click', ()=> switchView('form'));
    }

    async function saveSettings(){
      const s = {
        form_title: document.getElementById('settingFormTitle').value.trim(),
        budget_year: document.getElementById('settingBudgetYear').value.trim(),
        organization_name: document.getElementById('settingOrganizationName').value.trim(),
        doc_number_format: document.getElementById('settingDocNumberFormat').value.trim(),
        logo_url: document.getElementById('settingLogoUrl').value.trim(),
        whatsapp_number: document.getElementById('settingWhatsAppNumber').value.trim(),
        submit_button_text: defaultConfig.submit_button_text,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      // save to localStorage for persistence
      localStorage.setItem('atk_form_title', s.form_title);
      localStorage.setItem('atk_budget_year', s.budget_year);
      localStorage.setItem('atk_org', s.organization_name);
      localStorage.setItem('atk_doc_prefix', s.doc_number_format);
      localStorage.setItem('atk_logo', s.logo_url);
      localStorage.setItem('atk_whatsapp_number', s.whatsapp_number);
      appSettings = s;
      applySettingsToUI();
      showToast('Settings disimpan (lokal)');
      switchView('form');
      // if dataSdk present, you can still save settings to sheet via sdk.create(s), but omitted here.
    }

    // ------------------ Data handler (adapter -> app) ------------------
    const dataHandler = {
      onDataChanged(data){
        const settingsRecords = data.filter(r=>r.recordType==='settings');
        appSettings = settingsRecords.length>0 ? settingsRecords[0] : appSettings;
        currentRequests = data;
        applySettingsToUI();
        if(currentView==='requests') renderAllRequests();
        if(currentView==='form') updateDocumentNumber();
      }
    };

    // ------------------ View switcher ------------------
    function switchView(view){
      currentView = view;
      const ids = ['requestFormView','allRequestsView','verifierView','supervisorView','requestDetailView','settingsView'];
      ids.forEach(id=>{ const el=document.getElementById(id); if(!el) return; el.classList.add('hidden'); });
      if(view==='form') document.getElementById('requestFormView').classList.remove('hidden');
      else if(view==='requests'){ document.getElementById('allRequestsView').classList.remove('hidden'); renderAllRequests(); }
      else if(view==='verifier') document.getElementById('verifierView').classList.remove('hidden');
      else if(view==='supervisor') document.getElementById('supervisorView').classList.remove('hidden');
      else if(view==='detail') document.getElementById('requestDetailView').classList.remove('hidden');
      else if(view==='settings') { document.getElementById('settingsView').classList.remove('hidden'); loadSettingsForm(); }
    }
    window.switchView = switchView;

    // Print (helper)
    window.printDocument = function(){ if(currentView!=='detail'){ showToast('Buka detail permintaan dulu', true); return; } setTimeout(()=>window.print(),150); };

    // Hook top nav buttons
    document.getElementById('newRequestBtn').addEventListener('click', ()=>{ resetForm(); switchView('form'); });
    document.getElementById('viewRequestsBtn').addEventListener('click', ()=> switchView('requests'));
    document.getElementById('verifierViewBtn').addEventListener('click', ()=> switchView('verifier'));
    document.getElementById('supervisorViewBtn').addEventListener('click', ()=> switchView('supervisor'));
    document.getElementById('settingsBtn').addEventListener('click', ()=> switchView('settings'));
    document.getElementById('exportExcelBtnTop').addEventListener('click', ()=> exportAllRequestsToXLSXFiltered()); // top export uses current filter defaults (All)

    // ------------------ Init app: attempt to init SDK if adapter present (no UI for clientId now) ---
    async function init(){
      // fallback settings
      const lForm=localStorage.getItem('atk_form_title');
      if(lForm) appSettings = Object.assign({}, getCurrentSettings());

      // attempt to init adapter automatically if adapter and localStorage sheet/client exist (optional)
      const sdk = ensureDataSdk();
      const cid = localStorage.getItem('atk_google_client_id');
      const sid = localStorage.getItem('atk_google_sheet_id');
      if(sdk && sdk.init && cid && sid){
        try{
          const r = await sdk.init(dataHandler, {clientId: cid, spreadsheetId: sid});
          if(r && r.isOk){ showToast('Terhubung ke Google Sheets'); }
        }catch(e){ console.warn('sdk.init failed', e); }
      } else {
        if(!sdk) console.warn('dataSdk not available ‚Äî running in local/demo mode');
      }

      renderFormView();
      applySettingsToUI();

      // prepare filters (month+year) for All Requests view
      populateFilters();
      document.getElementById('filterMonth').addEventListener('change', ()=> renderAllRequestsFiltered());
      document.getElementById('filterYear').addEventListener('change', ()=> renderAllRequestsFiltered());
      document.getElementById('exportFilteredBtn').addEventListener('click', ()=> exportAllRequestsToXLSXFiltered());
    }

    // ------------------ Filters: month & year ------------------
    function populateFilters(){
      const monthEl = document.getElementById('filterMonth');
      const yearEl = document.getElementById('filterYear');
      const months = ['All','01 - January','02 - February','03 - March','04 - April','05 - May','06 - June','07 - July','08 - August','09 - September','10 - October','11 - November','12 - December'];
      monthEl.innerHTML = months.map((m,i)=>`<option value="${i===0? 'all' : (String(i).padStart(2,'0'))}">${m}</option>`).join('');
      // years: from currentYear-5 .. +2
      const cy=(new Date()).getFullYear();
      let options = '<option value="all">All</option>';
      for(let y=cy+2; y>=cy-5; y--){ options += `<option value="${y}">${y}</option>`; }
      yearEl.innerHTML = options;
    }

    function renderAllRequestsFiltered(){
      const month = document.getElementById('filterMonth').value; // 'all' or '01'..'12'
      const year = document.getElementById('filterYear').value; // 'all' or '2025'
      const container = document.getElementById('allRequestsList');
      const all = (currentRequests||[]).filter(r=>r.recordType==='request');
      // apply filters
      const filtered = all.filter(r=>{
        if(month !== 'all'){
          const d = r.submissionDate ? new Date(r.submissionDate) : null;
          const m = d ? String(d.getMonth()+1).padStart(2,'0') : null;
          if(m !== month) return false;
        }
        if(year !== 'all'){
          if(String(r.year) !== String(year)) return false;
        }
        return true;
      });
      if(filtered.length===0){ container.innerHTML = '<p class="text-gray-500 text-center py-8">Tidak ada data sesuai filter</p>'; return; }
      container.innerHTML = '';
      // re-use render card logic
      filtered.slice().sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt)).forEach(r=>{
        const card=document.createElement('div'); card.className='border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow';
        const statusBadge = `<span class="px-3 py-1 rounded-full text-sm font-semibold ${getStatusColor(r.status)}">${r.status}</span>`;
        card.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <div class="flex-1 cursor-pointer">
              <h3 class="font-bold text-lg text-gray-800">${escapeHtml(r.documentNumber)}</h3>
              <p class="text-sm text-gray-600">${escapeHtml(r.workUnit)} - ${escapeHtml(r.year)}</p>
            </div>
            <div class="flex gap-2 items-start">
              ${statusBadge}
              <button class="open-wa px-3 py-1 bg-green-500 text-white rounded-lg">üì± Buka WA</button>
              <button class="delete-req px-3 py-1 bg-red-500 text-white rounded-lg">üóëÔ∏è Hapus</button>
            </div>
          </div>
          <div class="cursor-pointer view-detail">
            <p class="text-sm text-gray-700 mb-2"><strong>Requester:</strong> ${escapeHtml(r.requesterName)} (${escapeHtml(r.requesterNIP)})</p>
            <p class="text-sm text-gray-600"><strong>Date:</strong> ${formatDate(r.submissionDate)}</p>
          </div>
        `;
        card.querySelector('.view-detail').addEventListener('click', ()=> window.viewRequestDetail(r.__backendId || r.documentNumber));
        card.querySelector('.open-wa').addEventListener('click', ()=> openWhatsApp(r.__backendId || r.documentNumber));
        card.querySelector('.delete-req').addEventListener('click', async (ev)=> {
          ev.stopPropagation();
          if(!confirm('Yakin ingin menghapus permintaan ini?')) return;
          const sdk = ensureDataSdk();
          if(sdk && sdk.delete){
            const result = await sdk.delete(r);
            if(result && result.isOk){ showToast('Permintaan berhasil dihapus'); renderAllRequestsFiltered(); }
            else { showToast('Gagal menghapus', true); console.error('delete error', result); }
          } else {
            currentRequests = currentRequests.filter(x => (x.__backendId || x.documentNumber) !== (r.__backendId || r.documentNumber));
            renderAllRequestsFiltered();
            showToast('Dihapus (local)');
          }
        });
        container.appendChild(card);
      });
    }

    // ------------------ Export filtered data to XLSX ------------------
    function exportAllRequestsToXLSXFiltered(){
      const month = document.getElementById('filterMonth') ? document.getElementById('filterMonth').value : 'all';
      const year = document.getElementById('filterYear') ? document.getElementById('filterYear').value : 'all';
      // select filtered array same way as renderAllRequestsFiltered
      const all = (currentRequests||[]).filter(r=>r.recordType==='request');
      const rows = all.filter(r=>{
        if(month !== 'all'){
          const d = r.submissionDate ? new Date(r.submissionDate) : null;
          const m = d ? String(d.getMonth()+1).padStart(2,'0') : null;
          if(m !== month) return false;
        }
        if(year !== 'all'){
          if(String(r.year) !== String(year)) return false;
        }
        return true;
      });

      if(!rows || rows.length===0){ showToast('Tidak ada data untuk diexport (sesuai filter)', true); return; }

      // Build worksheet data
      const wsData = [];
      wsData.push([
        'Backend ID','Document Number','Year','Work Unit','Submission Date','Submission Location','Requester Name','Requester NIP','Status','Verifier Name','Verifier NIP','Verification Date','Supervisor Name','Supervisor NIP','Supervisor Approval Date','Rejection Reason','Rejected By','Created At','Updated At','Items'
      ]);

      rows.forEach(r=>{
        let itemsText='';
        try{
          const items = typeof r.items === 'string' ? JSON.parse(r.items || '[]') : (r.items || []);
          itemsText = items.map(it => { const notes = it.notes ? ` [${it.notes}]` : ''; return `${it.name} (${it.quantity})${notes}`; }).join(' ; ');
        }catch(e){ itemsText = String(r.items||''); }
        wsData.push([
          r.__backendId || '',
          r.documentNumber || '',
          r.year || '',
          r.workUnit || '',
          r.submissionDate ? formatDate(r.submissionDate) : '',
          r.submissionLocation || '',
          r.requesterName || '',
          r.requesterNIP || '',
          r.status || '',
          r.verifierName || '',
          r.verifierNIP || '',
          r.verificationDate || '',
          r.supervisorName || '',
          r.supervisorNIP || '',
          r.supervisorApprovalDate || '',
          r.rejectionReason || '',
          r.rejectedBy || '',
          r.createdAt || '',
          r.updatedAt || '',
          itemsText
        ]);
      });

      const ws = XLSX.utils.aoa_to_sheet(wsData);
      // auto width
      const colWidths = wsData[0].map((h,i) => {
        let max = h ? String(h).length : 10;
        for(let r=1;r<wsData.length;r++){ const v = wsData[r][i]; if(v) max = Math.max(max, String(v).length); }
        return { wch: Math.min(Math.max(max+2, 10), 60) };
      });
      ws['!cols'] = colWidths;
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Permintaan_ATK');

      const now = new Date();
      const ts = now.toISOString().replace(/[:.]/g, '-');
      const filename = `rekap_permintaan_atk_${ts}.xlsx`;
      XLSX.writeFile(wb, filename);
    }

    // Also expose a top-level export that treats filters as 'All' by default
    function exportAllRequestsToXLSX(){
      // temporarily set filters to 'all'
      const prevMonth = document.getElementById('filterMonth') ? document.getElementById('filterMonth').value : 'all';
      const prevYear = document.getElementById('filterYear') ? document.getElementById('filterYear').value : 'all';
      if(document.getElementById('filterMonth')) document.getElementById('filterMonth').value = 'all';
      if(document.getElementById('filterYear')) document.getElementById('filterYear').value = 'all';
      exportAllRequestsToXLSXFiltered();
      if(document.getElementById('filterMonth')) document.getElementById('filterMonth').value = prevMonth;
      if(document.getElementById('filterYear')) document.getElementById('filterYear').value = prevYear;
    }

    // ------------------ Init & start ------------------
    init();

    // expose export for top button
    window.exportAllRequestsToXLSXFiltered = exportAllRequestsToXLSXFiltered;
    window.exportAllRequestsToXLSX = exportAllRequestsToXLSX;

  }); // DOMContentLoaded end
  </script>
</body>
</html>
