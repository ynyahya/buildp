<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Form Permintaan ATK - BPS Kota Jakarta Selatan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SignaturePad -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <style>
    body { box-sizing: border-box; }
    .toast {
      position: fixed; top: 16px; right: 16px; z-index: 9999;
      background: #10b981; color: white; padding: 10px 16px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.12);
    }
    .toast.error { background: #ef4444; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:9998; }
    .modal { background:white; border-radius:8px; padding:20px; max-width:900px; width:96%; }
    /* print */
    @media print {
      .no-print { display: none !important; }
    }
    /* Signature box border */
    .signature-box { border: 2px dashed #c7d2fe; padding: 8px; border-radius: 6px; background: #fff; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">
  <div class="max-w-6xl mx-auto p-4">

    <!-- Top navbar buttons -->
    <div class="no-print flex gap-3 justify-center mb-6">
      <button id="btnNew" class="px-4 py-2 bg-blue-600 text-white rounded">üìù Permintaan Baru</button>
      <button id="btnList" class="px-4 py-2 bg-gray-700 text-white rounded">üìã Semua Permintaan</button>
      <button id="btnVerifier" class="px-4 py-2 bg-orange-600 text-white rounded">‚úÖ Verifikator</button>
      <button id="btnSupervisor" class="px-4 py-2 bg-purple-600 text-white rounded">üëî Penanggung Jawab</button>
      <button id="btnSettings" class="px-4 py-2 bg-slate-700 text-white rounded">‚öôÔ∏è Pengaturan</button>
      <button id="btnExport" class="px-4 py-2 bg-indigo-700 text-white rounded">üì• Export Excel</button>
    </div>

    <!-- Form view -->
    <div id="viewForm" class="bg-white rounded shadow p-6 print-section">
      <div class="flex items-center gap-6 justify-between mb-6">
        <div class="flex items-center gap-4">
          <div id="logoContainer" class="w-20 h-20"></div>
          <div>
            <h1 id="uiFormTitle" class="text-2xl font-bold text-center">Form Permintaan ATK</h1>
            <p id="uiOrg" class="text-sm text-gray-600">BPS Kota Jakarta Selatan</p>
            <p id="uiYear" class="text-sm text-gray-600">Tahun Anggaran 2025</p>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
          <label class="block text-sm font-semibold mb-1">No Dokumen</label>
          <input id="documentNumber" class="w-full px-3 py-2 border rounded bg-gray-100" readonly />
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Tahun</label>
          <select id="yearSelect" class="w-full px-3 py-2 border rounded"></select>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Bagian/Fungsi</label>
          <select id="workUnitSelect" class="w-full px-3 py-2 border rounded">
            <option value="">Pilih Bagian/Fungsi</option>
            <option>Subbagian Umum</option>
            <option>Sosial</option>
            <option>Produksi</option>
            <option>Distribusi</option>
            <option>Nerwilis</option>
            <option>IPDS</option>
          </select>
        </div>
      </div>

      <!-- Items -->
      <div class="mb-6">
        <div class="flex justify-between items-center mb-3">
          <h2 class="font-bold text-lg">Rincian ATK</h2>
          <button id="addRowBtn" class="px-3 py-2 bg-green-600 text-white rounded">+ Tambah Item</button>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full border-collapse border border-gray-200">
            <thead class="bg-gray-100">
              <tr>
                <th class="border px-3 py-2 w-12 text-left">No</th>
                <th class="border px-3 py-2 text-left">Nama Item</th>
                <th class="border px-3 py-2 w-28">Jumlah</th>
                <th class="border px-3 py-2 w-48">Satuan</th>
                <th class="border px-3 py-2 w-32 no-print">Aksi</th>
              </tr>
            </thead>
            <tbody id="itemsTableBody"></tbody>
          </table>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div>
          <label class="block text-sm font-semibold mb-1">Lokasi Pengajuan</label>
          <input id="submissionLocation" class="w-full px-3 py-2 border rounded" value="Jakarta" />
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Tanggal Pengajuan</label>
          <input id="submissionDate" type="date" class="w-full px-3 py-2 border rounded" />
        </div>
      </div>

      <div class="mb-6">
        <h3 class="font-bold mb-2">Informasi Pemohon</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-1">Nama *</label>
            <input id="requesterName" placeholder="Nama pemohon" class="w-full px-3 py-2 border rounded" />
          </div>
          <div>
            <label class="block text-sm mb-1">NIP *</label>
            <input id="requesterNIP" placeholder="contoh: 199012345678901234" class="w-full px-3 py-2 border rounded" />
          </div>
        </div>
      </div>

      <!-- Signature area for Pemohon -->
      <div class="mb-6">
        <label class="block font-semibold mb-2">Tanda Tangan Digital (Pemohon)</label>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="signature-box">
            <canvas id="sigRequester" style="width:100%; height:220px; background:white;"></canvas>
            <div class="mt-2 flex gap-2">
              <button id="clearRequester" class="px-3 py-2 bg-red-500 text-white rounded">Clear</button>
              <button id="saveRequester" class="px-3 py-2 bg-green-600 text-white rounded">Save Signature</button>
            </div>
          </div>
          <div class="p-3 bg-blue-50 rounded text-sm text-gray-700">
            <strong>‚ÑπÔ∏è Petunjuk:</strong>
            <p>Tanda tangan menggunakan mouse atau sentuh pada area di kiri. Setelah disimpan, tanda tangan akan tercantum pada dokumen.</p>
          </div>
        </div>
      </div>

      <div class="mb-6">
        <button id="submitRequestBtn" class="w-full bg-blue-600 text-white px-4 py-3 rounded text-lg">Kirim Permintaan</button>
      </div>
    </div>

    <!-- All requests -->
    <div id="viewList" class="hidden">
      <div class="bg-white rounded shadow p-6">
        <h2 class="text-2xl font-bold mb-4">Semua Permintaan ATK</h2>
        <div class="flex gap-3 items-center mb-4">
          <label>Bulan:</label>
          <select id="filterMonth" class="px-2 py-1 border rounded">
            <option value="">Semua</option>
            ${(() => { let s=''; for(let m=1;m<=12;m++){ s+=`<option value="${m.toString().padStart(2,'0')}">${m}</option>` } return s })()}
          </select>
          <label>Tahun:</label>
          <select id="filterYear" class="px-2 py-1 border rounded"></select>
          <button id="applyFilter" class="px-3 py-1 bg-blue-500 text-white rounded">Apply</button>
          <button id="clearFilter" class="px-3 py-1 bg-gray-300 rounded">Reset</button>
        </div>
        <div id="allRequestsList"></div>
      </div>
    </div>

    <!-- Verifier -->
    <div id="viewVerifier" class="hidden">
      <div class="bg-white rounded shadow p-6">
        <h2 class="text-2xl font-bold mb-4">Dashboard Verifikator</h2>
        <div id="verifierRequestsList"></div>
      </div>
    </div>

    <!-- Supervisor -->
    <div id="viewSupervisor" class="hidden">
      <div class="bg-white rounded shadow p-6">
        <h2 class="text-2xl font-bold mb-4">Dashboard Penanggung Jawab</h2>
        <div id="supervisorRequestsList"></div>
      </div>
    </div>

    <!-- Detail view -->
    <div id="viewDetail" class="hidden bg-white rounded shadow p-6 print-section"></div>

    <!-- Settings -->
    <div id="viewSettings" class="hidden bg-white rounded shadow p-6">
      <h2 class="text-2xl font-bold mb-4">Pengaturan</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block mb-1">Form Title</label>
          <input id="settingFormTitle" class="w-full px-3 py-2 border rounded" />
        </div>
        <div>
          <label class="block mb-1">Budget Year</label>
          <input id="settingBudgetYear" class="w-full px-3 py-2 border rounded" />
        </div>
        <div>
          <label class="block mb-1">Organization Name</label>
          <input id="settingOrganizationName" class="w-full px-3 py-2 border rounded" />
        </div>
        <div>
          <label class="block mb-1">Prefix Nomor Dokumen</label>
          <input id="settingDocPrefix" class="w-full px-3 py-2 border rounded" placeholder="contoh: 0001" />
          <p class="text-xs text-gray-500 mt-1">Format final: [AUTO]/ATK/[BULAN]/[TAHUN]</p>
        </div>
        <div>
          <label class="block mb-1">Logo URL (opsional)</label>
          <input id="settingLogoUrl" class="w-full px-3 py-2 border rounded" />
        </div>
        <div>
          <label class="block mb-1">Nomor WhatsApp Notifikasi</label>
          <input id="settingWhatsApp" class="w-full px-3 py-2 border rounded" placeholder="628123..." />
        </div>
      </div>
      <div class="mt-4 flex gap-2">
        <button id="saveSettingsBtn" class="px-4 py-2 bg-green-600 text-white rounded">üíæ Save Settings</button>
        <button id="cancelSettingsBtn" class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
      </div>
    </div>

  </div>

  <script>
  /***********************
   * Simple localStorage DB
   ***********************/
  const STORAGE_KEYS = {
    SETTINGS: 'atk_app_settings_v1',
    REQUESTS: 'atk_app_requests_v1'
  };

  function loadSettings() {
    const raw = localStorage.getItem(STORAGE_KEYS.SETTINGS);
    const defaults = {
      form_title: "Form Permintaan ATK",
      budget_year: (new Date()).getFullYear().toString(),
      organization_name: "BPS Kota Jakarta Selatan",
      logo_url: "https://upload.wikimedia.org/wikipedia/commons/thumb/2/28/Lambang_Badan_Pusat_Statistik_%28BPS%29_Indonesia.svg/1160px-Lambang_Badan_Pusat_Statistik_%28BPS%29_Indonesia.svg.png",
      doc_prefix: "0001",
      whatsapp_number: ""
    };
    if (!raw) return defaults;
    try { const s = JSON.parse(raw); return {...defaults, ...s}; } catch(e){ return defaults; }
  }
  function saveSettings(s) { localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(s)); }

  function loadRequests() {
    const raw = localStorage.getItem(STORAGE_KEYS.REQUESTS);
    if (!raw) return [];
    try { return JSON.parse(raw); } catch(e){ return []; }
  }
  function saveRequests(arr) { localStorage.setItem(STORAGE_KEYS.REQUESTS, JSON.stringify(arr)); }

  /***********************
   * App state
   ***********************/
  let appSettings = loadSettings();
  let currentRequests = loadRequests();
  let currentView = 'form';
  let editingRequestId = null;

  /***********************
   * Utilities
   ***********************/
  function showToast(message, isError=false) {
    const el = document.createElement('div');
    el.className = 'toast' + (isError ? ' error' : '');
    el.textContent = message;
    document.body.appendChild(el);
    setTimeout(()=> el.remove(), 3000);
  }

  function uid() {
    return 'id_' + Math.random().toString(36).slice(2, 11);
  }

  function pad(n, len=4){ return n.toString().padStart(len,'0'); }

  function applySettingsToUI() {
    document.getElementById('uiFormTitle').textContent = appSettings.form_title;
    document.getElementById('uiOrg').textContent = appSettings.organization_name;
    document.getElementById('uiYear').textContent = `Tahun Anggaran ${appSettings.budget_year}`;
    // logo
    const logoHTML = appSettings.logo_url ? `<img src="${appSettings.logo_url}" alt="Logo" class="w-20 h-20 object-contain" onerror="this.style.display='none'">` : '';
    document.getElementById('logoContainer').innerHTML = logoHTML;
  }

  function initYearSelects() {
    const yearSelect = document.getElementById('yearSelect');
    const filterYear = document.getElementById('filterYear');
    yearSelect.innerHTML='';
    filterYear.innerHTML='';
    const cur = new Date().getFullYear();
    for(let y=cur-5;y<=cur+5;y++){
      const opt = document.createElement('option'); opt.value=y; opt.textContent=y; if(y==cur) opt.selected=true; yearSelect.appendChild(opt);
      const opt2 = document.createElement('option'); opt2.value=y; opt2.textContent=y; if(y==cur) opt2.selected=true; filterYear.appendChild(opt2);
    }
  }

  // Document number generation
  function generateDocumentNumber() {
    const year = document.getElementById('yearSelect').value || appSettings.budget_year;
    const submissionDate = document.getElementById('submissionDate').value;
    let month='01';
    if (submissionDate) {
      const d = new Date(submissionDate);
      month = String(d.getMonth()+1).padStart(2,'0');
    } else {
      const d = new Date();
      month = String(d.getMonth()+1).padStart(2,'0');
    }

    // find max existing for same month/year
    const existing = currentRequests.filter(r => r.documentNumber && r.documentNumber.includes(`/ATK/${month}/${year}`))
      .map(r => {
        const parts = r.documentNumber.split('/');
        return parseInt(parts[0]) || 0;
      });
    const next = existing.length ? Math.max(...existing)+1 : (parseInt(appSettings.doc_prefix) || 1);
    return `${pad(next,4)}/ATK/${month}/${year}`;
  }

  /***********************
   * Items table
   ***********************/
  function addItemRow(name='', qty=1, notes='') {
    const tbody = document.getElementById('itemsTableBody');
    const tr = document.createElement('tr');
    const idx = tbody.children.length + 1;
    tr.innerHTML = `
      <td class="border px-3 py-2 text-center">${idx}</td>
      <td class="border px-3 py-2"><input class="item-name w-full px-2 py-1 border rounded" value="${escapeHtml(name)}" /></td>
      <td class="border px-3 py-2 text-center"><input type="number" class="item-qty w-20 px-2 py-1 border rounded" min="1" value="${qty}" /></td>
      <td class="border px-3 py-2"><input class="item-notes w-full px-2 py-1 border rounded" value="${escapeHtml(notes)}" /></td>
      <td class="border px-3 py-2 text-center no-print"><button class="delete-row px-3 py-1 bg-red-500 text-white rounded">Hapus</button></td>
    `;
    tbody.appendChild(tr);
    tr.querySelector('.delete-row').addEventListener('click', () => { tr.remove(); updateRowNumbers(); });
  }
  function updateRowNumbers() {
    const tbody = document.getElementById('itemsTableBody');
    Array.from(tbody.children).forEach((row,i)=> row.children[0].textContent = i+1);
  }
  function getItemsFromTable() {
    const tbody = document.getElementById('itemsTableBody');
    const items=[];
    Array.from(tbody.children).forEach(row => {
      const name = row.querySelector('.item-name').value.trim();
      const qty = parseInt(row.querySelector('.item-qty').value) || 0;
      const notes = row.querySelector('.item-notes').value.trim();
      if(name && qty>0) items.push({name, quantity: qty, notes});
    });
    return items;
  }

  /***********************
   * Signature pads
   ***********************/
  let sigRequesterPad, sigVerifierPad, sigSupervisorPad;
  function initSignaturePads() {
    const cReq = document.getElementById('sigRequester');
    function resizeCanvas(c){
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      const parent = c.parentElement;
      c.width = parent.clientWidth * ratio;
      c.height = 220 * ratio;
      c.style.width = parent.clientWidth + 'px';
      c.style.height = '220px';
      const ctx = c.getContext('2d');
      ctx.scale(ratio, ratio);
    }
    // init requester
    resizeCanvas(cReq);
    sigRequesterPad = new SignaturePad(cReq, { backgroundColor: 'rgba(0,0,0,0)', penColor: 'rgb(20,60,160)' });
    // clear & save buttons
    document.getElementById('clearRequester').addEventListener('click', ()=> sigRequesterPad.clear());
    document.getElementById('saveRequester').addEventListener('click', ()=> {
      if (sigRequesterPad.isEmpty()) { showToast('Tanda tangan kosong', true); return; }
      const dataUrl = sigRequesterPad.toDataURL();
      // store temporarily in local preview field (not saved to request until submit)
      sessionStorage.setItem('pending_sig_requester', dataUrl);
      showToast('Tanda tangan pemohon disimpan (sementara). Silakan lanjut kirim permintaan.');
    });

    // On window resize adjust canvas
    window.addEventListener('resize', ()=> resizeCanvas(cReq));
  }

  /***********************
   * Submit request
   ***********************/
  async function submitRequest() {
    // validate
    const year = document.getElementById('yearSelect').value;
    const workUnit = document.getElementById('workUnitSelect').value;
    const items = getItemsFromTable();
    const requesterName = document.getElementById('requesterName').value.trim();
    const requesterNIP = document.getElementById('requesterNIP').value.trim();
    if(!year){ showToast('Mohon pilih tahun', true); return; }
    if(!workUnit){ showToast('Mohon pilih bagian/fungsi', true); return; }
    if(items.length===0){ showToast('Mohon tambahkan minimal 1 item', true); return; }
    if(!requesterName){ showToast('Mohon isi nama pemohon', true); return; }
    if(!requesterNIP){ showToast('Mohon isi NIP pemohon', true); return; }

    try {
      const docNum = generateDocumentNumber();
      const submissionDate = document.getElementById('submissionDate').value || new Date().toISOString().split('T')[0];
      const submissionLocation = document.getElementById('submissionLocation').value.trim();
      // retrieve saved signature in session (saved by Save Signature button)
      const sigRequester = sessionStorage.getItem('pending_sig_requester') || null;

      const requestObj = {
        __id: uid(),
        recordType: 'request',
        documentNumber: docNum,
        year,
        workUnit,
        items,
        submissionDate,
        submissionLocation,
        requesterName,
        requesterNIP,
        status: 'Pending Verification',
        verifierName: "",
        verifierNIP: "",
        verificationDate: "",
        supervisorName: "",
        supervisorNIP: "",
        supervisorApprovalDate: "",
        rejectionReason: "",
        rejectedBy: "",
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        signatureRequester: sigRequester,
        signatureVerifier: null,
        signatureSupervisor: null
      };

      currentRequests.push(requestObj);
      saveRequests(currentRequests);
      sessionStorage.removeItem('pending_sig_requester');

      showToast('Permintaan berhasil dikirim dan disimpan!');
      resetForm();
      renderAllRequests();
      renderVerifierDashboard();
      renderSupervisorDashboard();
      switchView('requests');
    } catch (e) {
      console.error(e);
      showToast('Gagal mengirim: ' + (e.message || e), true);
    }
  }

  function resetForm() {
    document.getElementById('workUnitSelect').value = '';
    document.getElementById('itemsTableBody').innerHTML = '';
    addItemRow();
    document.getElementById('requesterName').value='';
    document.getElementById('requesterNIP').value='';
    document.getElementById('submissionLocation').value = 'Jakarta';
    document.getElementById('submissionDate').value = (new Date()).toISOString().split('T')[0];
    document.getElementById('documentNumber').value = generateDocumentNumber();
    // clear signature pad
    if (sigRequesterPad) sigRequesterPad.clear();
    sessionStorage.removeItem('pending_sig_requester');
  }

  /***********************
   * Render functions
   ***********************/
  function getStatusColorClass(status) {
    switch(status){
      case 'Pending Verification': return 'bg-yellow-200 text-yellow-800';
      case 'Verified - Pending Approval': return 'bg-blue-200 text-blue-800';
      case 'Fully Approved': return 'bg-green-200 text-green-800';
      default: return 'bg-gray-200 text-gray-800';
    }
  }

  function renderAllRequests() {
    const container = document.getElementById('allRequestsList');
    const filterM = document.getElementById('filterMonth').value;
    const filterY = document.getElementById('filterYear').value;
    let list = currentRequests.filter(r=> r.recordType==='request');
    if(filterM) list = list.filter(r => {
      const month = (new Date(r.submissionDate)).getMonth()+1;
      return month === parseInt(filterM);
    });
    if(filterY) list = list.filter(r => r.year == filterY);

    if(list.length===0) { container.innerHTML = '<p class="text-gray-500">Belum ada permintaan</p>'; return; }

    // sort newest
    list.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
    container.innerHTML = list.map(r=>{
      const colorClass = getStatusColorClass(r.status);
      return `
        <div class="border rounded p-4 mb-3 hover:shadow">
          <div class="flex justify-between items-start">
            <div class="cursor-pointer" onclick="viewRequestDetail('${r.__id}')">
              <h3 class="font-bold">${escapeHtml(r.documentNumber)}</h3>
              <p class="text-sm text-gray-600">${escapeHtml(r.workUnit)} - ${escapeHtml(r.year)}</p>
            </div>
            <div class="flex gap-2 items-center">
              <span class="px-3 py-1 rounded-full text-sm font-semibold ${colorClass}">${escapeHtml(r.status)}</span>
              <button onclick="openWhatsApp('${r.__id}')" class="px-3 py-1 bg-green-500 text-white rounded text-sm">üì± Buka WA</button>
              <button onclick="deleteRequest('${r.__id}', event)" class="px-3 py-1 bg-red-500 text-white rounded text-sm">üóëÔ∏è Hapus</button>
            </div>
          </div>
          <div class="mt-3 cursor-pointer" onclick="viewRequestDetail('${r.__id}')">
            <p class="text-sm"><strong>Requester:</strong> ${escapeHtml(r.requesterName)} (${escapeHtml(r.requesterNIP)})</p>
            <p class="text-sm text-gray-600"><strong>Date:</strong> ${formatDate(r.submissionDate)}</p>
          </div>
        </div>
      `;
    }).join('');
  }

  function renderVerifierDashboard() {
    const container = document.getElementById('verifierRequestsList');
    const pending = currentRequests.filter(r => r.recordType==='request' && r.status==='Pending Verification');
    if(pending.length===0) { container.innerHTML = '<p class="text-gray-500">Tidak ada permintaan yang menunggu verifikasi</p>'; return; }
    container.innerHTML = pending.map(r=>`
      <div class="border p-4 rounded mb-3 hover:shadow cursor-pointer" onclick="viewRequestDetail('${r.__id}')">
        <div class="flex justify-between">
          <div>
            <h3 class="font-bold">${escapeHtml(r.documentNumber)}</h3>
            <p class="text-sm text-gray-600">${escapeHtml(r.workUnit)} - ${escapeHtml(r.year)}</p>
          </div>
          <span class="px-3 py-1 rounded-full bg-yellow-200 text-yellow-800 text-sm">Step 1: Pending Verification</span>
        </div>
        <p class="text-sm mt-2"><strong>Requester:</strong> ${escapeHtml(r.requesterName)} (${escapeHtml(r.requesterNIP)})</p>
      </div>
    `).join('');
  }

  function renderSupervisorDashboard() {
    const container = document.getElementById('supervisorRequestsList');
    const pending = currentRequests.filter(r => r.recordType==='request' && r.status==='Verified - Pending Approval');
    if(pending.length===0) { container.innerHTML = '<p class="text-gray-500">Tidak ada permintaan yang menunggu persetujuan akhir</p>'; return; }
    container.innerHTML = pending.map(r=>`
      <div class="border p-4 rounded mb-3 hover:shadow cursor-pointer" onclick="viewRequestDetail('${r.__id}')">
        <div class="flex justify-between">
          <div>
            <h3 class="font-bold">${escapeHtml(r.documentNumber)}</h3>
            <p class="text-sm text-gray-600">${escapeHtml(r.workUnit)} - ${escapeHtml(r.year)}</p>
          </div>
          <span class="px-3 py-1 rounded-full bg-blue-200 text-blue-800 text-sm">Step 2: Pending Final Approval</span>
        </div>
        <p class="text-sm mt-2"><strong>Requester:</strong> ${escapeHtml(r.requesterName)} (${escapeHtml(r.requesterNIP)})</p>
        <p class="text-sm mt-1 text-gray-600"><strong>Verified by:</strong> ${escapeHtml(r.verifierName || '-')}</p>
      </div>
    `).join('');
  }

  /***********************
   * View switcher
   ***********************/
  function hideAllViews() {
    ['viewForm','viewList','viewVerifier','viewSupervisor','viewDetail','viewSettings'].forEach(id => document.getElementById(id).classList.add('hidden'));
  }

  function switchView(view) {
    currentView = view;
    hideAllViews();
    document.getElementById('view' + capitalize(view)).classList.remove('hidden');
    // updates
    if(view==='requests') renderAllRequests();
    if(view==='verifier') renderVerifierDashboard();
    if(view==='supervisor') renderSupervisorDashboard();
    if(view==='form') {
      document.getElementById('documentNumber').value = generateDocumentNumber();
    }
    if(view==='settings') loadSettingsForm();
  }

  function capitalize(s){ if(!s) return s; return s[0].toUpperCase()+s.slice(1); }

  /***********************
   * Detail view
   ***********************/
  function viewRequestDetail(id) {
    const request = currentRequests.find(r=> r.__id === id);
    if(!request) return;
    editingRequestId = id;
    const settings = appSettings;
    const container = document.getElementById('viewDetail');
    const itemsHtml = request.items.map((it, idx) => `
      <tr>
        <td class="border px-3 py-2 text-center">${idx+1}</td>
        <td class="border px-3 py-2">${escapeHtml(it.name)}</td>
        <td class="border px-3 py-2 text-center">${escapeHtml(it.quantity)}</td>
        <td class="border px-3 py-2">${escapeHtml(it.notes || '-')}</td>
      </tr>
    `).join('');
    container.innerHTML = `
      <div class="no-print mb-4">
        <button onclick="switchView('${determineReturnView()}')" class="px-3 py-2 bg-gray-500 text-white rounded">‚Üê Back</button>
        <button onclick="window.print()" class="ml-2 px-3 py-2 bg-blue-500 text-white rounded">üñ®Ô∏è Print / Export PDF</button>
      </div>
      <div class="mb-6">
        <div class="flex items-center gap-4">
          <div class="w-20">${settings.logo_url ? `<img src="${settings.logo_url}" class="w-20 h-20 object-contain" />` : ''}</div>
          <div>
            <h1 class="text-2xl font-bold">${escapeHtml(settings.form_title)}</h1>
            <p class="text-sm text-gray-600">Tahun Anggaran ${escapeHtml(settings.budget_year)}</p>
            <p class="text-sm text-gray-600">${escapeHtml(settings.organization_name)}</p>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-3 gap-4 mb-4">
        <div><p class="text-sm text-gray-600">Document Number</p><p class="font-semibold">${escapeHtml(request.documentNumber)}</p></div>
        <div><p class="text-sm text-gray-600">Year</p><p class="font-semibold">${escapeHtml(request.year)}</p></div>
        <div><p class="text-sm text-gray-600">Work Unit</p><p class="font-semibold">${escapeHtml(request.workUnit)}</p></div>
      </div>

      <div class="mb-6">
        <h3 class="font-bold mb-2">ATK Items</h3>
        <table class="w-full border-collapse border border-gray-200">
          <thead class="bg-gray-100">
            <tr><th class="border px-3 py-2">No</th><th class="border px-3 py-2">Item Name</th><th class="border px-3 py-2">Quantity</th><th class="border px-3 py-2">Notes / Unit</th></tr>
          </thead>
          <tbody>${itemsHtml}</tbody>
        </table>
      </div>

      <p class="mb-2"><strong>Submission:</strong> ${escapeHtml(request.submissionLocation)}, ${formatDate(request.submissionDate)}</p>
      <p class="mb-4"><strong>Status:</strong> <span class="px-3 py-1 rounded-full ${getStatusColorClass(request.status)}">${escapeHtml(request.status)}</span></p>

      <div class="border-t pt-6 mb-6">
        <h3 class="font-bold mb-2">Requester Information</h3>
        <div class="grid grid-cols-2 gap-4 mb-3">
          <div><p class="text-sm text-gray-600">Name</p><p class="font-semibold">${escapeHtml(request.requesterName)}</p></div>
          <div><p class="text-sm text-gray-600">NIP</p><p class="font-semibold">${escapeHtml(request.requesterNIP)}</p></div>
        </div>
        ${request.signatureRequester ? `
          <div class="p-4 bg-green-50 rounded">
            <p class="text-green-700 font-semibold mb-2">‚úì DIGITALLY SIGNED</p>
            <img src="${request.signatureRequester}" alt="sig" style="max-width:320px; display:block; border:1px solid #d1fae5; background:white;"/>
            <p class="text-sm mt-2">Signed by: ${escapeHtml(request.requesterName)} | NIP: ${escapeHtml(request.requesterNIP)} | Date: ${formatDate(request.submissionDate)}</p>
          </div>
        ` : `<p class="text-sm text-gray-500">Belum ada tanda tangan pemohon</p>`}
      </div>

      <!-- Verifier / Supervisor signatures display -->
      <div class="mb-6 border-t pt-6">
        <h3 class="font-bold mb-4 text-center">GOODS RELEASE SECTION</h3>
        <div class="grid grid-cols-3 gap-6">
          <div class="text-center">
            <p class="text-sm font-semibold mb-2">Verifikator</p>
            ${request.signatureVerifier ? `
              <div class="p-4 border rounded bg-green-50">
                <img src="${request.signatureVerifier}" style="max-width:240px; display:block; margin:0 auto;"/>
                <p class="text-sm mt-2">${escapeHtml(request.verifierName)} | ${escapeHtml(request.verifierNIP)} | ${formatDate(request.verificationDate)}</p>
              </div>` : '<p class="text-gray-500">Not verified</p>'}
          </div>
          <div class="text-center">
            <p class="text-sm font-semibold mb-2">Penanggung Jawab</p>
            ${request.signatureSupervisor ? `
              <div class="p-4 border rounded bg-green-50">
                <img src="${request.signatureSupervisor}" style="max-width:240px; display:block; margin:0 auto;"/>
                <p class="text-sm mt-2">${escapeHtml(request.supervisorName)} | ${escapeHtml(request.supervisorNIP)} | ${formatDate(request.supervisorApprovalDate)}</p>
              </div>` : '<p class="text-gray-500">Not approved</p>'}
          </div>
          <div class="text-center">
            <p class="text-sm font-semibold mb-2">Requester</p>
            ${request.signatureRequester ? `
              <div class="p-4 border rounded bg-green-50">
                <img src="${request.signatureRequester}" style="max-width:240px; display:block; margin:0 auto;"/>
                <p class="text-sm mt-2">${escapeHtml(request.requesterName)} | ${escapeHtml(request.requesterNIP)} | ${formatDate(request.submissionDate)}</p>
              </div>` : '<p class="text-gray-500">No signature</p>'}
          </div>
        </div>
      </div>

      <!-- If pending verification, show verifier input -->
      ${request.status === 'Pending Verification' ? `
        <div class="no-print border-t pt-6">
          <h3 class="font-bold mb-3">Verifikator Section (Step 1 of 2)</h3>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div><input id="verifierName" placeholder="Verifikator Name" class="w-full px-3 py-2 border rounded" /></div>
            <div><input id="verifierNIP" placeholder="Verifikator NIP" class="w-full px-3 py-2 border rounded" /></div>
          </div>
          <div class="mb-4">
            <label class="block mb-2">Tanda Tangan Verifikator</label>
            <div class="signature-box"><canvas id="sigVerifier" style="width:100%; height:160px; background:white;"></canvas></div>
            <div class="flex gap-2 mt-2">
              <button id="clearVerifier" class="px-3 py-2 bg-red-500 text-white rounded">Clear</button>
              <button id="saveVerifier" class="px-3 py-2 bg-green-600 text-white rounded">Save Signature</button>
            </div>
          </div>
          <div class="flex gap-2">
            <button onclick="verifyRequest()" class="px-4 py-2 bg-green-600 text-white rounded">‚úì Verify & Send to Penanggung Jawab</button>
            <button onclick="showRejectModal('verifier')" class="px-4 py-2 bg-red-600 text-white rounded">‚úó Reject Request</button>
          </div>
        </div>
      ` : ''}

      ${request.status === 'Verified - Pending Approval' ? `
        <div class="no-print border-t pt-6">
          <h3 class="font-bold mb-3">Penanggung Jawab Final Approval (Step 2 of 2)</h3>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div><input id="supervisorName" placeholder="Penanggung Jawab Name" class="w-full px-3 py-2 border rounded" /></div>
            <div><input id="supervisorNIP" placeholder="Penanggung Jawab NIP" class="w-full px-3 py-2 border rounded" /></div>
          </div>
          <div class="mb-4">
            <label class="block mb-2">Tanda Tangan Penanggung Jawab</label>
            <div class="signature-box"><canvas id="sigSupervisor" style="width:100%; height:180px; background:white;"></canvas></div>
            <div class="flex gap-2 mt-2">
              <button id="clearSupervisor" class="px-3 py-2 bg-red-500 text-white rounded">Clear</button>
              <button id="saveSupervisor" class="px-3 py-2 bg-green-600 text-white rounded">Save Signature</button>
            </div>
          </div>
          <div class="flex gap-2">
            <button onclick="approveRequestFinal()" class="px-4 py-2 bg-green-600 text-white rounded">‚úì Give Final Approval</button>
            <button onclick="showRejectModal('supervisor')" class="px-4 py-2 bg-red-600 text-white rounded">‚úó Reject Request</button>
          </div>
        </div>
      ` : ''}

    `;

    // After injecting detail DOM, init verifier/supervisor signature pads if present
    setTimeout(()=> {
      // init verifier pad if exists
      const sv = document.getElementById('sigVerifier');
      if(sv){
        initSigPadForDetail('sigVerifier', 'clearVerifier', 'saveVerifier', (dataUrl) => {
          // store temporarily in session until verifyRequest called
          sessionStorage.setItem('pending_sig_verifier', dataUrl);
          showToast('Tanda tangan verifikator disimpan (sementara).');
        });
      }
      const ss = document.getElementById('sigSupervisor');
      if(ss){
        initSigPadForDetail('sigSupervisor', 'clearSupervisor', 'saveSupervisor', (dataUrl) => {
          sessionStorage.setItem('pending_sig_supervisor', dataUrl);
          showToast('Tanda tangan penanggung jawab disimpan (sementara).');
        });
      }
      // prefill verifier/supervisor inputs if existing
      const req = request;
      if(document.getElementById('verifierName')) document.getElementById('verifierName').value = req.verifierName || '';
      if(document.getElementById('verifierNIP')) document.getElementById('verifierNIP').value = req.verifierNIP || '';
      if(document.getElementById('supervisorName')) document.getElementById('supervisorName').value = req.supervisorName || '';
      if(document.getElementById('supervisorNIP')) document.getElementById('supervisorNIP').value = req.supervisorNIP || '';
    }, 50);

    switchView('detail');
  }

  function initSigPadForDetail(canvasId, clearBtnId, saveBtnId, onSave) {
    const c = document.getElementById(canvasId);
    function resize(){
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      const parent = c.parentElement;
      c.width = parent.clientWidth * ratio;
      c.height = (c.style.height ? parseInt(c.style.height) : 160) * ratio;
      c.style.width = parent.clientWidth + 'px';
      c.style.height = (c.height/ratio) + 'px';
      const ctx = c.getContext('2d'); ctx.scale(ratio, ratio);
    }
    resize();
    const pad = new SignaturePad(c, { backgroundColor: 'rgba(0,0,0,0)', penColor: 'rgb(20,60,160)' });
    if(document.getElementById(clearBtnId)) document.getElementById(clearBtnId).addEventListener('click', ()=>pad.clear());
    if(document.getElementById(saveBtnId)) document.getElementById(saveBtnId).addEventListener('click', ()=> {
      if(pad.isEmpty()) { showToast('Tanda tangan kosong', true); return; }
      const d = pad.toDataURL();
      onSave(d);
    });
    window.addEventListener('resize', resize);
  }

  function determineReturnView(){
    // if currentView before detail was verifier or supervisor, return that, else requests
    if(currentView==='verifier') return 'verifier';
    if(currentView==='supervisor') return 'supervisor';
    return 'requests';
  }

  /***********************
   * Verification & Approval
   ***********************/
  async function verifyRequest() {
    const verifierName = document.getElementById('verifierName').value.trim();
    const verifierNIP = document.getElementById('verifierNIP').value.trim();
    if(!verifierName || !verifierNIP){ showToast('Please enter verifikator name and NIP', true); return; }
    const request = currentRequests.find(r=> r.__id === editingRequestId);
    if(!request) { showToast('Request not found', true); return; }

    // get pending signature from session
    const sigVer = sessionStorage.getItem('pending_sig_verifier') || null;
    if(!sigVer){ showToast('Mohon simpan tanda tangan verifikator terlebih dahulu', true); return; }

    request.status = 'Verified - Pending Approval';
    request.verifierName = verifierName;
    request.verifierNIP = verifierNIP;
    request.verificationDate = new Date().toISOString().split('T')[0];
    request.signatureVerifier = sigVer;
    request.updatedAt = new Date().toISOString();
    saveRequests(currentRequests);
    sessionStorage.removeItem('pending_sig_verifier');

    showToast('Request verified! Sent to Penanggung Jawab');
    renderVerifierDashboard();
    renderSupervisorDashboard();
    switchView('verifier');
  }

  async function approveRequestFinal() {
    const supervisorName = document.getElementById('supervisorName').value.trim();
    const supervisorNIP = document.getElementById('supervisorNIP').value.trim();
    if(!supervisorName || !supervisorNIP){ showToast('Please enter penanggung jawab name and NIP', true); return; }
    const request = currentRequests.find(r=> r.__id === editingRequestId);
    if(!request) { showToast('Request not found', true); return; }
    const sigSup = sessionStorage.getItem('pending_sig_supervisor') || null;
    if(!sigSup){ showToast('Mohon simpan tanda tangan penanggung jawab terlebih dahulu', true); return; }

    request.status = 'Fully Approved';
    request.supervisorName = supervisorName;
    request.supervisorNIP = supervisorNIP;
    request.supervisorApprovalDate = new Date().toISOString().split('T')[0];
    request.signatureSupervisor = sigSup;
    request.updatedAt = new Date().toISOString();
    saveRequests(currentRequests);
    sessionStorage.removeItem('pending_sig_supervisor');

    showToast('Request fully approved! Ready for printing');
    renderSupervisorDashboard();
    renderAllRequests();
    switchView('supervisor');
  }

  /***********************
   * Reject modal
   ***********************/
  function showRejectModal(role) {
    const modal = document.createElement('div'); modal.className='modal-backdrop';
    modal.innerHTML = `
      <div class="modal">
        <h3 class="font-bold text-lg mb-2">Reject Request</h3>
        <p class="text-sm text-gray-600 mb-2">Please provide a reason for rejection:</p>
        <textarea id="rejectReasonInput" class="w-full p-2 border rounded mb-4"></textarea>
        <div class="flex gap-2">
          <button id="cancelReject" class="px-3 py-2 bg-gray-300 rounded">Cancel</button>
          <button id="confirmReject" class="px-3 py-2 bg-red-600 text-white rounded">Confirm Reject</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    modal.querySelector('#cancelReject').onclick = ()=> modal.remove();
    modal.querySelector('#confirmReject').onclick = async ()=>{
      const reason = document.getElementById('rejectReasonInput').value.trim();
      if(!reason) { showToast('Please provide a rejection reason', true); return; }
      const request = currentRequests.find(r=> r.__id === editingRequestId);
      if(!request) { showToast('Request not found', true); modal.remove(); return; }
      if(role === 'verifier'){
        const verifierName = document.getElementById('verifierName').value.trim();
        const verifierNIP = document.getElementById('verifierNIP').value.trim();
        if(!verifierName || !verifierNIP){ showToast('Please enter verifikator name and NIP', true); return; }
        request.status = 'Rejected by Verifier';
        request.verifierName = verifierName; request.verifierNIP = verifierNIP;
        request.verificationDate = new Date().toISOString().split('T')[0];
        request.rejectionReason = reason; request.rejectedBy = 'Verifikator';
      } else {
        const supervisorName = document.getElementById('supervisorName').value.trim();
        const supervisorNIP = document.getElementById('supervisorNIP').value.trim();
        if(!supervisorName || !supervisorNIP){ showToast('Please enter penanggung jawab name and NIP', true); return; }
        request.status = 'Rejected by Supervisor';
        request.supervisorName = supervisorName; request.supervisorNIP = supervisorNIP;
        request.supervisorApprovalDate = new Date().toISOString().split('T')[0];
        request.rejectionReason = reason; request.rejectedBy = 'Penanggung Jawab';
      }
      request.updatedAt = new Date().toISOString();
      saveRequests(currentRequests);
      modal.remove();
      showToast('Request rejected');
      renderVerifierDashboard();
      renderSupervisorDashboard();
      renderAllRequests();
      switchView(role==='verifier' ? 'verifier' : 'supervisor');
    };
  }

  /***********************
   * Delete request
   ***********************/
  function deleteRequest(id, ev) {
    if(ev) ev.stopPropagation();
    if(!confirm('Yakin ingin menghapus permintaan ini?')) return;
    currentRequests = currentRequests.filter(r=> r.__id !== id);
    saveRequests(currentRequests);
    showToast('Permintaan berhasil dihapus');
    renderAllRequests(); renderVerifierDashboard(); renderSupervisorDashboard();
  }

  /***********************
   * WhatsApp link
   ***********************/
  function getWhatsAppUrl(requestId) {
    const request = currentRequests.find(r=> r.__id === requestId);
    if(!request) return null;
    const wa = appSettings.whatsapp_number;
    if(!wa) return null;
    const items = request.items.map((it,i)=> `${i+1}. ${it.name} (${it.quantity})`).join('%0A');
    let message = `*Pengingat Permintaan ATK*%0A%0A`;
    message += `*Dokumen:* ${request.documentNumber}%0A`;
    message += `*Status:* ${request.status}%0A`;
    message += `*Bagian:* ${request.workUnit}%0A`;
    message += `*Pemohon:* ${request.requesterName} (${request.requesterNIP})%0A%0A`;
    message += `*Items:*%0A${items}%0A%0A`;
    message += `*Tanggal Pengajuan:* ${formatDate(request.submissionDate)}`;
    return `https://wa.me/${wa}?text=${message}`;
  }
  function openWhatsApp(requestId) {
    const url = getWhatsAppUrl(requestId);
    if(!url){ showToast('Nomor WhatsApp belum diatur di Pengaturan', true); return; }
    window.open(url, '_blank', 'noopener');
  }

  /***********************
   * Settings UI
   ***********************/
  function loadSettingsForm(){
    document.getElementById('settingFormTitle').value = appSettings.form_title;
    document.getElementById('settingBudgetYear').value = appSettings.budget_year;
    document.getElementById('settingOrganizationName').value = appSettings.organization_name;
    document.getElementById('settingDocPrefix').value = appSettings.doc_prefix;
    document.getElementById('settingLogoUrl').value = appSettings.logo_url;
    document.getElementById('settingWhatsApp').value = appSettings.whatsapp_number;
  }

  function saveSettingsFromUI(){
    const form_title = document.getElementById('settingFormTitle').value.trim();
    const budget_year = document.getElementById('settingBudgetYear').value.trim();
    const organization_name = document.getElementById('settingOrganizationName').value.trim();
    const doc_prefix = document.getElementById('settingDocPrefix').value.trim();
    const logo_url = document.getElementById('settingLogoUrl').value.trim();
    const whatsapp_number = document.getElementById('settingWhatsApp').value.trim();
    if(!form_title || !budget_year || !organization_name || !doc_prefix){ showToast('Mohon isi field wajib', true); return; }
    appSettings = { ...appSettings, form_title, budget_year, organization_name, doc_prefix, logo_url, whatsapp_number };
    saveSettings(appSettings);
    applySettingsToUI();
    initYearSelects();
    showToast('Settings berhasil disimpan!');
    switchView('form');
  }

  /***********************
   * Export CSV (Excel)
   ***********************/
  function exportCSV() {
    const filterM = document.getElementById('filterMonth').value;
    const filterY = document.getElementById('filterYear').value;
    let list = currentRequests.filter(r=> r.recordType === 'request');
    if(filterM) list = list.filter(r => (new Date(r.submissionDate)).getMonth()+1 === parseInt(filterM));
    if(filterY) list = list.filter(r => r.year == filterY);
    if(list.length===0){ showToast('Tidak ada data untuk diexport', true); return; }
    // build CSV
    const rows = [];
    rows.push(['DocumentNumber','Year','WorkUnit','RequesterName','RequesterNIP','SubmissionDate','Status','Items']);
    list.forEach(r=>{
      const items = r.items.map(i=> `${i.name} (${i.quantity})`).join(' | ');
      rows.push([r.documentNumber, r.year, r.workUnit, r.requesterName, r.requesterNIP, r.submissionDate, r.status, items]);
    });
    const csvContent = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `atk_export_${(new Date()).toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  /***********************
   * Helpers
   ***********************/
  function formatDate(iso) {
    if(!iso) return '-';
    const d = new Date(iso);
    const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
  }

  function escapeHtml(s='') {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  /***********************
   * Init app
   ***********************/
  function init() {
    // setup UI handlers
    document.getElementById('btnNew').addEventListener('click', ()=> { resetForm(); switchView('form'); });
    document.getElementById('btnList').addEventListener('click', ()=> { switchView('requests'); });
    document.getElementById('btnVerifier').addEventListener('click', ()=> { switchView('verifier'); });
    document.getElementById('btnSupervisor').addEventListener('click', ()=> { switchView('supervisor'); });
    document.getElementById('btnSettings').addEventListener('click', ()=> { switchView('settings'); });
    document.getElementById('btnExport').addEventListener('click', ()=> exportCSV());

    document.getElementById('addRowBtn').addEventListener('click', ()=> addItemRow());
    document.getElementById('submitRequestBtn').addEventListener('click', submitRequest);

    document.getElementById('saveSettingsBtn').addEventListener('click', saveSettingsFromUI);
    document.getElementById('cancelSettingsBtn').addEventListener('click', ()=> switchView('form'));

    document.getElementById('applyFilter').addEventListener('click', renderAllRequests);
    document.getElementById('clearFilter').addEventListener('click', ()=> { document.getElementById('filterMonth').value=''; document.getElementById('filterYear').value=''; renderAllRequests(); });

    // init settings & UI
    initYearSelects();
    appSettings = loadSettings();
    applySettingsToUI();

    // set submission date default and doc number
    document.getElementById('submissionDate').value = (new Date()).toISOString().split('T')[0];
    document.getElementById('documentNumber').value = generateDocumentNumber();

    // add initial item row
    addItemRow();

    // signature pads for form
    initSignaturePads();

    // render lists initially
    renderAllRequests();
    renderVerifierDashboard();
    renderSupervisorDashboard();
  }

  // expose functions for inline HTML usage
  window.viewRequestDetail = viewRequestDetail;
  window.switchView = (v)=> switchView(v==='requests' ? 'requests' : v); // small helper
  window.deleteRequest = deleteRequest;
  window.openWhatsApp = openWhatsApp;

  // start
  init();
  </script>
</body>
</html>
