<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Form Permintaan ATK - BPS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Signature Pad -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

  <style>
    /* Base box sizing */
    *,*::before,*::after{box-sizing:border-box}

    /* Toast */
    .toast { position: fixed; top: 16px; right: 16px; background: #10b981; color:#fff; padding:10px 14px; border-radius:8px; z-index:1200; box-shadow:0 6px 18px rgba(0,0,0,0.08); font-size:14px }
    .toast.error { background:#ef4444 }

    /* Signature / print helpers */
    .print-section { page-break-inside: avoid; }
    .signature-card { border:1px dashed #c7d2fe; border-radius:8px; padding:8px; background:#fafafa; }
    canvas.signature-canvas { width:100% !important; border-radius:6px; background:white; border:1px solid #e5e7eb; touch-action:none; display:block; }

    .digital-signature { border:2px solid #10b981; background:#f0fdf4; padding:12px; border-radius:8px; font-family:'Courier New', monospace; }

    /* signature img responsive */
    .sig-img { display:block; margin:0 auto; width:100%; max-width:320px; height:auto; border-radius:6px; border:1px solid #e5e7eb; padding:6px; background:#fff }

    /* responsive canvas heights */
    canvas.signature-canvas { height:180px !important; }
    @media (min-width: 640px) { /* sm */
      canvas.signature-canvas { height:220px !important; }
      .sig-img { max-width:260px }
    }
    @media (min-width: 768px) { /* md */
      canvas.signature-canvas { height:300px !important; }
      .sig-img { max-width:320px }
    }

    /* top toolbar wrap on small screens */
    .top-toolbar { display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center; }
    .top-toolbar button { flex:1 1 auto; min-width:120px; }

    /* smaller spacing on small devices */
    @media (max-width:639px){
      .container-core { padding-left:12px; padding-right:12px; }
      .no-print .top-button { padding:8px 10px; font-size:13px }
      .text-lg { font-size:1rem }
      .signature-card { padding:6px }
    }

    /* PRINT */
    @media print{
      .no-print { display:none !important; }
      body { background:#fff !important; margin:0; padding:0 }
      .print-section { page-break-inside: avoid; box-shadow:none !important }
      #app { max-width:100% !important; padding:0 !important; margin:0 !important }
      #viewDetail { box-shadow:none !important; border:none !important; padding:12px !important }
      table { page-break-inside:auto; width:100% }
      tr { page-break-inside:avoid; page-break-after:auto }
      .digital-signature { print-color-adjust:exact; -webkit-print-color-adjust:exact }
      .sig-img { max-width:180px !important; max-height:90px !important }
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen text-gray-800">
  <div id="app" class="container-core max-w-5xl mx-auto p-4 sm:p-6">

    <!-- TOP TOOLBAR (responsive) -->
    <div class="no-print top-toolbar mb-4">
      <button id="btnNew" class="top-button px-3 py-2 bg-blue-600 text-white rounded shadow-sm">üìù Permintaan Baru</button>
      <button id="btnAll" class="top-button px-3 py-2 bg-gray-700 text-white rounded shadow-sm">üìã Semua Permintaan</button>
      <button id="btnVerifier" class="top-button px-3 py-2 bg-orange-600 text-white rounded shadow-sm">‚úÖ Verifikator</button>
      <button id="btnSupervisor" class="top-button px-3 py-2 bg-purple-600 text-white rounded shadow-sm">üëî Penanggung Jawab</button>
      <button id="btnSettings" class="top-button px-3 py-2 bg-gray-800 text-white rounded shadow-sm">‚öôÔ∏è Pengaturan</button>
      <button id="btnExportAll" class="top-button px-3 py-2 bg-indigo-700 text-white rounded shadow-sm">üì§ Export Excel</button>
    </div>

    <!-- FORM (default view) -->
    <div id="viewForm" class="bg-white rounded-lg shadow p-4 sm:p-6 print-section">
      <div class="text-center mb-4">
        <h1 id="uiFormTitle" class="text-2xl sm:text-3xl font-bold">Form Permintaan ATK</h1>
        <p id="uiBudgetYear" class="text-sm text-gray-600">Tahun Anggaran 2025</p>
        <p id="uiOrg" class="text-sm text-gray-500">BPS Kota Jakarta Selatan</p>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3">
        <div>
          <label class="text-sm font-semibold">No Dokumen</label>
          <input id="documentNumber" readonly class="mt-2 w-full px-3 py-2 border rounded bg-gray-100 text-sm">
        </div>
        <div>
          <label class="text-sm font-semibold">Tahun</label>
          <select id="yearSelect" class="mt-2 w-full border rounded px-3 py-2 text-sm"></select>
        </div>
        <div>
          <label class="text-sm font-semibold">Bagian/Fungsi</label>
          <select id="workUnitSelect" class="mt-2 w-full border rounded px-3 py-2 text-sm">
            <option value="">Pilih Bagian/Fungsi</option>
            <option>Subbagian Umum</option><option>Sosial</option><option>Produksi</option><option>Distribusi</option><option>Nerwilis</option><option>IPDS</option>
          </select>
        </div>
      </div>

      <div class="mb-3">
        <div class="flex justify-between items-center mb-2">
          <h2 class="font-bold text-lg">Rincian ATK</h2>
          <button id="btnAddItem" class="no-print px-3 py-1 bg-green-600 text-white rounded text-sm">+ Tambah Item</button>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full border-collapse text-sm">
            <thead>
              <tr class="bg-gray-100">
                <th class="p-2 border">No</th><th class="p-2 border">Nama Item</th><th class="p-2 border w-24">Jumlah</th><th class="p-2 border">Satuan</th><th class="p-2 border">Aksi</th>
              </tr>
            </thead>
            <tbody id="itemsTableBody"></tbody>
          </table>
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
        <div>
          <label class="text-sm font-semibold">Lokasi Pengajuan</label>
          <input id="submissionLocation" value="Jakarta" class="mt-2 w-full px-3 py-2 border rounded text-sm">
        </div>
        <div>
          <label class="text-sm font-semibold">Tanggal Pengajuan</label>
          <input id="submissionDate" type="date" class="mt-2 w-full px-3 py-2 border rounded text-sm">
        </div>
      </div>

      <div class="border-t pt-4 mb-4">
        <h2 class="text-lg font-bold mb-2">Informasi Pemohon</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
          <div><label class="text-sm">Nama *</label><input id="requesterName" class="mt-2 w-full px-3 py-2 border rounded text-sm" placeholder="Nama pemohon"></div>
          <div><label class="text-sm">NIP *</label><input id="requesterNIP" class="mt-2 w-full px-3 py-2 border rounded text-sm" placeholder="contoh: 199012345678901234"></div>
        </div>

        <div class="mb-3 p-3 bg-blue-50 border rounded">
          <div class="flex flex-col sm:flex-row items-start gap-3">
            <div class="w-full sm:w-1/2">
              <p class="text-sm font-semibold mb-1">Tanda Tangan Digital (Pemohon)</p>
              <div class="signature-card">
                <canvas id="requesterSignatureCanvas" class="signature-canvas"></canvas>
                <div class="flex gap-2 mt-2">
                  <button id="reqSigClear" class="px-3 py-1 bg-red-500 text-white rounded text-sm">Clear</button>
                  <button id="reqSigSave" class="px-3 py-1 bg-green-600 text-white rounded text-sm">Save Signature</button>
                </div>
              </div>
              <p class="text-xs text-gray-600 mt-2">‚ÑπÔ∏è Gunakan mouse atau sentuh. Setelah disimpan, tanda tangan akan muncul pada dokumen.</p>
            </div>
            <div class="flex-1 text-sm text-gray-700">
              <!-- instruksi tambahan -->
            </div>
          </div>
        </div>

        <div class="mt-2">
          <button id="submitRequestBtn" class="w-full sm:w-auto px-4 py-2 bg-blue-600 text-white rounded font-bold">Kirim Permintaan</button>
        </div>
      </div>
    </div>

    <!-- VIEW: ALL REQUESTS -->
    <div id="viewAll" class="hidden bg-white rounded-lg shadow p-4 sm:p-6">
      <div class="flex items-center gap-3 mb-3">
        <h2 class="text-lg sm:text-2xl font-bold">Semua Permintaan ATK</h2>
        <div class="ml-auto flex items-center gap-2">
          <label class="text-sm">Filter Bulan</label>
          <select id="filterMonth" class="border rounded px-2 py-1 text-sm">
            <option value="">Semua</option>
            <option value="01">Jan</option><option value="02">Feb</option><option value="03">Mar</option>
            <option value="04">Apr</option><option value="05">Mei</option><option value="06">Jun</option>
            <option value="07">Jul</option><option value="08">Agu</option><option value="09">Sep</option>
            <option value="10">Okt</option><option value="11">Nov</option><option value="12">Des</option>
          </select>
          <label class="text-sm">Tahun</label>
          <select id="filterYear" class="border rounded px-2 py-1 text-sm"></select>
          <button id="btnExportFiltered" class="ml-2 px-3 py-1 bg-indigo-700 text-white rounded text-sm">Export</button>
        </div>
      </div>
      <div id="allRequestsList" class="space-y-3"></div>
    </div>

    <!-- VERIFIER -->
    <div id="viewVerifier" class="hidden bg-white rounded-lg shadow p-4 sm:p-6">
      <h2 class="text-xl font-bold mb-3">Dashboard Verifikator</h2>
      <div id="verifierRequestsList" class="space-y-3"></div>
    </div>

    <!-- SUPERVISOR -->
    <div id="viewSupervisor" class="hidden bg-white rounded-lg shadow p-4 sm:p-6">
      <h2 class="text-xl font-bold mb-3">Dashboard Penanggung Jawab</h2>
      <div id="supervisorRequestsList" class="space-y-3"></div>
    </div>

    <!-- DETAIL -->
    <div id="viewDetail" class="hidden bg-white rounded-lg shadow p-4 sm:p-6 print-section"></div>

  </div>

  <div id="toastContainer"></div>

<script>
/* Minimal JS mostly same as sebelumnya but kept responsive-friendly */
const STORAGE_KEY='atk_requests_v1';
const SETTINGS_KEY='atk_settings_v1';
function loadLocalRequests(){ try{ const raw=localStorage.getItem(STORAGE_KEY); return raw?JSON.parse(raw):[] }catch(e){return[]} }
function saveLocalRequests(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(currentRequests)); }catch(e){} }
function loadSettings(){ try{ const s=localStorage.getItem(SETTINGS_KEY); return s?JSON.parse(s):null }catch(e){return null} }
function saveSettingsToStorage(){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings)); }
function showToast(msg,isError=false){ const el=document.createElement('div'); el.className=`toast ${isError?'error':''}`; el.textContent=msg; document.body.appendChild(el); setTimeout(()=>el.remove(),3000); }

let currentRequests=loadLocalRequests();
let appSettings=loadSettings()||{
  form_title:"Form Permintaan ATK",
  budget_year:(new Date()).getFullYear().toString(),
  organization_name:"BPS Kota Jakarta Selatan",
  logo_url:"", doc_prefix:"0001", doc_format:"{AUTO}/ATK/{MM}/{YYYY}", whatsapp_number:""
};

let requesterSigPad=null, verifierSigPad=null, supervisorSigPad=null;
const viewForm=document.getElementById('viewForm');
const viewAll=document.getElementById('viewAll');
const viewVerifier=document.getElementById('viewVerifier');
const viewSupervisor=document.getElementById('viewSupervisor');
const viewSettings=document.getElementById('viewSettings');
const viewDetail=document.getElementById('viewDetail');
const yearSelect=document.getElementById('yearSelect');
const filterYear=document.getElementById('filterYear');

function initYearDropdowns(){
  const currentYear=new Date().getFullYear();
  for(let i=currentYear-5;i<=currentYear+5;i++){
    const opt=document.createElement('option'); opt.value=i; opt.textContent=i; yearSelect.appendChild(opt);
    const o2=opt.cloneNode(true); filterYear.appendChild(o2);
  }
  yearSelect.value=appSettings.budget_year; filterYear.value=appSettings.budget_year;
}
function buildDocFormatPreview(){ const fmt=appSettings.doc_format||"{AUTO}/ATK/{MM}/{YYYY}"; const sample=new Date(); const mm=("0"+(sample.getMonth()+1)).slice(-2); const yyyy=sample.getFullYear(); const sampleAuto=(appSettings.doc_prefix||'1').replace(/^0+/,'')||'1'; const padded=(""+sampleAuto).padStart(4,'0'); const preview=fmt.replace(/\{AUTO\}/g,padded).replace(/\{MM\}/g,mm).replace(/\{YYYY\}/g,yyyy); const el=document.getElementById('docFormatPreview'); if(el) el.textContent=preview; }
function generateDocumentNumber(){ const year=yearSelect.value||new Date().getFullYear().toString(); const date=document.getElementById('submissionDate')?.value||(new Date()).toISOString().split('T')[0]; const month=("0"+(new Date(date).getMonth()+1)).slice(-2); const existing=currentRequests.filter(r=>r.recordType==='request'&&r.documentNumber).map(r=>{ const first=(r.documentNumber.split('/')[0]||'').replace(/\D/g,''); return parseInt(first,10)||0 }).filter(n=>n>0); const prefixNum=parseInt(String(appSettings.doc_prefix||'1').replace(/^0+/,''))||1; const next=existing.length?Math.max(...existing)+1:prefixNum; const padded=(""+next).padStart(4,'0'); const fmt=appSettings.doc_format||"{AUTO}/ATK/{MM}/{YYYY}"; return fmt.replace(/\{AUTO\}/g,padded).replace(/\{MM\}/g,month).replace(/\{YYYY\}/g,year); }
function updateDocumentNumber(){ try{ const doc=document.getElementById('documentNumber'); if(doc) doc.value=generateDocumentNumber(); }catch(e){console.error(e)} }

function addItemRow(name='',qty=1,unit=''){
  const tbody=document.getElementById('itemsTableBody'); const idx=tbody.children.length+1; const tr=document.createElement('tr');
  tr.innerHTML=`<td class="p-2 border text-center">${idx}</td>
    <td class="p-2 border"><input class="item-name w-full px-2 py-1 border rounded text-sm" value="${name}" placeholder="Masukkan nama item"></td>
    <td class="p-2 border text-center"><input type="number" min="1" class="item-quantity w-20 px-2 py-1 border rounded text-sm" value="${qty}"></td>
    <td class="p-2 border"><input class="item-unit w-full px-2 py-1 border rounded text-sm" value="${unit}" placeholder="Satuan"></td>
    <td class="p-2 border text-center"><button class="delete-row px-2 py-1 bg-red-500 text-white rounded text-sm">Hapus</button></td>`;
  tbody.appendChild(tr);
  tr.querySelector('.delete-row').addEventListener('click',()=>{ tr.remove(); updateRowNumbers(); });
}
function updateRowNumbers(){ const rows=Array.from(document.getElementById('itemsTableBody').children); rows.forEach((r,i)=> r.children[0].textContent=i+1); }
function getItemsFromTable(){ const rows=Array.from(document.getElementById('itemsTableBody').children); const items=[]; rows.forEach(row=>{ const name=row.querySelector('.item-name').value.trim(); const qty=parseInt(row.querySelector('.item-quantity').value)||0; const unit=row.querySelector('.item-unit').value.trim(); if(name && qty>0) items.push({name,quantity:qty,unit}); }); return items; }

function fitToContainer(canvas){ const ratio=Math.max(window.devicePixelRatio||1,1); const w=canvas.offsetWidth; const h=canvas.offsetHeight; canvas.width=Math.floor(w*ratio); canvas.height=Math.floor(h*ratio); const ctx=canvas.getContext('2d'); ctx.scale(ratio,ratio); }
function initRequestSignature(){ const canvas=document.getElementById('requesterSignatureCanvas'); if(!canvas) return; fitToContainer(canvas); requesterSigPad=new SignaturePad(canvas,{penColor:"rgb(0,80,160)"}); window.addEventListener('resize',()=>{ try{ fitToContainer(canvas); }catch(e){} }); }

function getStatusColorClass(status){ switch(status){ case 'Pending Verification': return 'bg-yellow-200 text-yellow-800'; case 'Verified - Pending Approval': return 'bg-blue-200 text-blue-800'; case 'Fully Approved': return 'bg-green-200 text-green-800'; case 'Rejected by Verifier': case 'Rejected by Supervisor': return 'bg-red-200 text-red-800'; default: return 'bg-gray-200 text-gray-800'; } }

function renderAllRequests(){
  const container=document.getElementById('allRequestsList'); const monthFilter=document.getElementById('filterMonth')?.value||''; const yearFilterVal=document.getElementById('filterYear')?.value||'';
  const list=currentRequests.filter(r=>r.recordType==='request').filter(r=>{ if(!monthFilter && !yearFilterVal) return true; const parts=(r.documentNumber||'').split('/'); const m=parts[2]||''; const y=parts[3]||''; if(monthFilter && yearFilterVal) return m===monthFilter && y===yearFilterVal; if(monthFilter) return m===monthFilter; if(yearFilterVal) return y===yearFilterVal; return true; }).sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
  if(list.length===0){ container.innerHTML='<p class="text-gray-500 py-6">Belum ada permintaan</p>'; return; }
  container.innerHTML = list.map(r=>`<div class="border rounded p-3 shadow-sm flex flex-col sm:flex-row sm:justify-between gap-2">
    <div onclick="viewRequestDetail('${r.__id}')" class="cursor-pointer">
      <h3 class="font-bold">${r.documentNumber}</h3>
      <p class="text-sm text-gray-600">${r.workUnit} - ${r.year}</p>
      <p class="text-sm text-gray-600 mt-2"><strong>Requester:</strong> ${r.requesterName} (${r.requesterNIP})</p>
      <p class="text-sm text-gray-600"><strong>Date:</strong> ${formatDate(r.submissionDate)}</p>
    </div>
    <div class="flex items-center gap-2 justify-end">
      <span class="px-3 py-1 rounded-full text-sm ${getStatusColorClass(r.status)}">${r.status}</span>
      <button onclick="openWhatsAppFor('${r.__id}')" class="px-3 py-1 bg-green-500 text-white rounded text-sm">üì± Buka WA</button>
      <button onclick="deleteRequest('${r.__id}', event)" class="px-3 py-1 bg-red-500 text-white rounded text-sm">üóëÔ∏è Hapus</button>
    </div>
  </div>`).join('');
}

function renderVerifierDashboard(){ const c=document.getElementById('verifierRequestsList'); const pending=currentRequests.filter(r=>r.recordType==='request'&&r.status==='Pending Verification'); if(pending.length===0){ c.innerHTML='<p class="text-gray-500 py-6">Tidak ada permintaan yang menunggu verifikasi</p>'; return } c.innerHTML=pending.map(r=>`<div class="border rounded p-3 hover:shadow-sm cursor-pointer" onclick="viewRequestDetail('${r.__id}')"><h3 class="font-bold">${r.documentNumber}</h3><p class="text-sm text-gray-600">${r.workUnit} - ${r.year}</p><p class="text-sm text-gray-700 mt-2"><strong>Requester:</strong> ${r.requesterName} (${r.requesterNIP})</p></div>`).join('') }

function renderSupervisorDashboard(){ const c=document.getElementById('supervisorRequestsList'); const pending=currentRequests.filter(r=>r.recordType==='request'&&r.status==='Verified - Pending Approval'); if(pending.length===0){ c.innerHTML='<p class="text-gray-500 py-6">Tidak ada permintaan yang menunggu persetujuan akhir</p>'; return } c.innerHTML=pending.map(r=>`<div class="border rounded p-3 hover:shadow-sm cursor-pointer" onclick="viewRequestDetail('${r.__id}')"><h3 class="font-bold">${r.documentNumber}</h3><p class="text-sm text-gray-600">${r.workUnit} - ${r.year}</p><p class="text-sm text-gray-700 mt-2"><strong>Requester:</strong> ${r.requesterName} (${r.requesterNIP})</p></div>`).join('') }

function createId(){ return 'r-'+Math.random().toString(36).slice(2,9); }

function submitRequest(){
  updateDocumentNumber();
  const year=yearSelect.value; const workUnit=document.getElementById('workUnitSelect').value; const items=getItemsFromTable(); const requesterName=document.getElementById('requesterName').value.trim(); const requesterNIP=document.getElementById('requesterNIP').value.trim();
  if(!year||!workUnit){ showToast('Mohon pilih tahun dan bagian/fungsi',true); return }
  if(items.length===0){ showToast('Mohon tambahkan minimal 1 item',true); return }
  if(!requesterName||!requesterNIP){ showToast('Mohon isi nama dan NIP pemohon',true); return }
  const docNumber=document.getElementById('documentNumber').value||generateDocumentNumber();
  const submissionDate=document.getElementById('submissionDate').value||(new Date()).toISOString().split('T')[0];
  const submissionLocation=document.getElementById('submissionLocation')?.value||'';
  const reqCanvas=document.getElementById('requesterSignatureCanvas'); const reqSignature=reqCanvas?.dataset?.dataurl||null;
  const record={ __id:createId(), recordType:'request', documentNumber:docNumber, year, workUnit, items, submissionDate, submissionLocation, requesterName, requesterNIP, requesterSignature:reqSignature, status:'Pending Verification', verifierName:'', verifierNIP:'', verificationDate:'', verifierSignature:'', supervisorName:'', supervisorNIP:'', supervisorApprovalDate:'', supervisorSignature:'', rejectionReason:'', rejectedBy:'', createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() };
  currentRequests.unshift(record); saveLocalRequests(); renderAllRequests(); renderVerifierDashboard(); renderSupervisorDashboard(); showToast('Permintaan berhasil dikirim'); resetForm(); switchView('all');
}
function resetForm(){ document.getElementById('workUnitSelect').value=''; document.getElementById('itemsTableBody').innerHTML=''; addItemRow(); document.getElementById('requesterName').value=''; document.getElementById('requesterNIP').value=''; document.getElementById('submissionDate').value=(new Date()).toISOString().split('T')[0]; document.getElementById('submissionLocation').value='Jakarta'; const c=document.getElementById('requesterSignatureCanvas'); if(c){ const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); c.dataset.dataurl=''; if(requesterSigPad) requesterSigPad.clear(); } }

function deleteRequest(id,event){ if(event) event.stopPropagation(); const idx=currentRequests.findIndex(r=>r.__id===id); if(idx===-1){ showToast('Permintaan tidak ditemukan',true); return } if(!confirm('Yakin ingin menghapus permintaan ini?')) return; currentRequests.splice(idx,1); saveLocalRequests(); renderAllRequests(); renderVerifierDashboard(); renderSupervisorDashboard(); showToast('Permintaan berhasil dihapus'); }

function openWhatsAppFor(id){
  const r=currentRequests.find(x=>x.__id===id); if(!r){ showToast('Request not found',true); return }
  const itemsList=(r.items||[]).map((it,idx)=>`${idx+1}. ${it.name} (${it.quantity})`).join('%0A'); let message=`*Pengingat Permintaan ATK*%0A%0A`; message+=`*Dokumen:* ${encodeURIComponent(r.documentNumber)}%0A`; message+=`*Status:* ${encodeURIComponent(r.status)}%0A`; message+=`*Bagian/Fungsi:* ${encodeURIComponent(r.workUnit)}%0A`; message+=`*Tahun:* ${encodeURIComponent(r.year)}%0A%0A`; message+=`*Pemohon:*%0ANama: ${encodeURIComponent(r.requesterName)}%0A NIP: ${encodeURIComponent(r.requesterNIP)}%0A%0A`; message+=`*Item yang Diminta:*%0A${itemsList}%0A%0A`; message+=`*Tanggal Pengajuan:* ${encodeURIComponent(formatDate(r.submissionDate))}%0A`; message+=`*Lokasi:* ${encodeURIComponent(r.submissionLocation)}%0A%0A`;
  if(appSettings.whatsapp_number && appSettings.whatsapp_number.trim()!==''){ const wa=`https://wa.me/${appSettings.whatsapp_number}?text=${message}`; window.open(wa,'_blank','noopener,noreferrer'); showToast('Membuka WhatsApp...'); } else { navigator.clipboard?.writeText(message).then(()=>showToast('Pesan disalin ke clipboard (paste ke WA)')); }
}

/* DETAIL view + GOODS RELEASE (responsive) */
function viewRequestDetail(id){
  const r=currentRequests.find(x=>x.__id===id); if(!r) return;
  viewDetail.innerHTML=`
    <div class="no-print mb-3 flex gap-2">
      <button id="backFromDetail" class="px-3 py-2 bg-gray-500 text-white rounded">‚Üê Back</button>
      <button id="btnPrint" class="px-3 py-2 bg-blue-500 text-white rounded">üñ®Ô∏è Print</button>
    </div>
    <div class="mb-4 border-b pb-3 flex items-center gap-3">
      <div style="width:56px;height:56px">${appSettings.logo_url?`<img src="${appSettings.logo_url}" style="width:56px;height:56px;object-fit:contain">`:''}</div>
      <div>
        <h2 class="text-lg font-bold">${escapeHtml(appSettings.form_title)}</h2>
        <div class="text-sm text-gray-600">${escapeHtml(appSettings.organization_name)}</div>
        <div class="text-xs text-gray-500">Tahun Anggaran ${escapeHtml(appSettings.budget_year)}</div>
      </div>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 mb-3 text-sm">
      <div><p class="font-semibold">Document Number</p><p>${escapeHtml(r.documentNumber)}</p></div>
      <div><p class="font-semibold">Year</p><p>${escapeHtml(r.year)}</p></div>
      <div><p class="font-semibold">Work Unit</p><p>${escapeHtml(r.workUnit)}</p></div>
    </div>
    <div class="mb-3">
      <h3 class="font-bold mb-2">ATK Items</h3>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead><tr class="bg-gray-100"><th class="p-2 border">No</th><th class="p-2 border">Item</th><th class="p-2 border">Qty</th><th class="p-2 border">Satuan</th></tr></thead>
          <tbody>${(r.items||[]).map((it,i)=>`<tr><td class="p-2 border text-center">${i+1}</td><td class="p-2 border">${escapeHtml(it.name)}</td><td class="p-2 border text-center">${escapeHtml(it.quantity)}</td><td class="p-2 border">${escapeHtml(it.unit||'-')}</td></tr>`).join('')}</tbody>
        </table>
      </div>
    </div>
    <div class="mb-3"><p class="text-sm"><strong>Submission:</strong> ${escapeHtml(r.submissionLocation)}, ${formatDate(r.submissionDate)}</p><p class="mt-2"><strong>Status:</strong> <span class="px-2 py-1 rounded ${getStatusColorClass(r.status)} text-sm">${r.status}</span></p></div>
    <div class="border-t pt-3 mb-3">
      <h3 class="font-bold mb-2">Requester Information</h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-2">
        <div><p class="text-sm font-semibold">Name</p><p>${escapeHtml(r.requesterName)}</p></div>
        <div><p class="text-sm font-semibold">NIP</p><p>${escapeHtml(r.requesterNIP)}</p></div>
      </div>
      <div class="mb-2">
        <div class="digital-signature">
          <p class="text-green-700 font-semibold mb-1">‚úì DIGITALLY SIGNED</p>
          ${r.requesterSignature?`<img src="${r.requesterSignature}" class="sig-img" style="max-width:240px;margin-top:8px;">`:'<p class="text-sm text-gray-600">No signature saved</p>'}
          <p class="text-xs text-gray-600 mt-2">Signed by: ${escapeHtml(r.requesterName)} | NIP: ${escapeHtml(r.requesterNIP)} | Date: ${formatDate(r.submissionDate)}</p>
        </div>
      </div>
    </div>
  `;
  document.getElementById('backFromDetail').addEventListener('click', ()=> switchView('all'));
  document.getElementById('btnPrint').addEventListener('click', ()=> window.print());

  // Verifikator / Supervisor sections (if pending) inserted similarly (omitted here for brevity)...
  // GOODS RELEASE SECTION: only shown when Fully Approved
  if(r.status === 'Fully Approved'){
    const goodsHtml = `<div id="goodsReleaseSection" class="border-t pt-4 print-section">
      <h3 class="text-center font-bold mb-4">GOODS RELEASE SECTION</h3>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-3">
        <div class="text-center">
          <p class="text-sm font-semibold mb-2">Verifikator</p>
          ${r.verifierSignature?`<img src="${r.verifierSignature}" class="sig-img">` : `<p class="text-gray-400 italic">No signature</p>`}
          ${r.verifierName?`<div class="digital-signature mt-2"><p class="text-green-700 font-semibold mb-1">‚úì DIGITALLY SIGNED</p><p class="text-sm"><strong>Signed by:</strong> ${escapeHtml(r.verifierName)}</p><p class="text-xs"><strong>NIP:</strong> ${escapeHtml(r.verifierNIP||'')}</p><p class="text-xs"><strong>Date:</strong> ${formatDate(r.verificationDate||'')}</p></div>`:``}
        </div>
        <div class="text-center">
          <p class="text-sm font-semibold mb-2">Penanggung Jawab</p>
          ${r.supervisorSignature?`<img src="${r.supervisorSignature}" class="sig-img">` : `<p class="text-gray-400 italic">No signature</p>`}
          ${r.supervisorName?`<div class="digital-signature mt-2"><p class="text-green-700 font-semibold mb-1">‚úì DIGITALLY SIGNED</p><p class="text-sm"><strong>Signed by:</strong> ${escapeHtml(r.supervisorName)}</p><p class="text-xs"><strong>NIP:</strong> ${escapeHtml(r.supervisorNIP||'')}</p><p class="text-xs"><strong>Date:</strong> ${formatDate(r.supervisorApprovalDate||'')}</p></div>`:``}
        </div>
        <div class="text-center">
          <p class="text-sm font-semibold mb-2">Requester</p>
          ${r.requesterSignature?`<img src="${r.requesterSignature}" class="sig-img">` : `<p class="text-gray-400 italic">No signature</p>`}
          <div class="digital-signature mt-2"><p class="text-green-700 font-semibold mb-1">‚úì DIGITALLY SIGNED</p><p class="text-sm"><strong>Signed by:</strong> ${escapeHtml(r.requesterName)}</p><p class="text-xs"><strong>NIP:</strong> ${escapeHtml(r.requesterNIP||'')}</p><p class="text-xs"><strong>Date:</strong> ${formatDate(r.submissionDate||'')}</p></div>
        </div>
      </div>
    </div>` ;
    viewDetail.insertAdjacentHTML('beforeend',goodsHtml);
  }

  switchView('detail');
}

/* UTIL */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function formatDate(d){ if(!d) return '-'; const date=new Date(d); const months=['January','February','March','April','May','June','July','August','September','October','November','December']; return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`; }
function switchView(name){ [viewForm,viewAll,viewVerifier,viewSupervisor,viewDetail].forEach(v=>v.classList.add('hidden')); if(name==='form') viewForm.classList.remove('hidden'); else if(name==='all'){ viewAll.classList.remove('hidden'); renderAllRequests(); } else if(name==='verifier'){ viewVerifier.classList.remove('hidden'); renderVerifierDashboard(); } else if(name==='supervisor'){ viewSupervisor.classList.remove('hidden'); renderSupervisorDashboard(); } else if(name==='detail'){ viewDetail.classList.remove('hidden'); } }

/* INIT */
function init(){
  initYearDropdowns();
  document.getElementById('submissionDate').value=(new Date()).toISOString().split('T')[0];
  addItemRow(); initRequestSignature();
  // buttons
  document.getElementById('btnNew').addEventListener('click',()=>switchView('form'));
  document.getElementById('btnAll').addEventListener('click',()=>switchView('all'));
  document.getElementById('btnVerifier').addEventListener('click',()=>switchView('verifier'));
  document.getElementById('btnSupervisor').addEventListener('click',()=>switchView('supervisor'));
  document.getElementById('btnExportAll').addEventListener('click',()=>{/* export simple */});
  document.getElementById('btnAddItem').addEventListener('click',()=>addItemRow());
  document.getElementById('reqSigClear').addEventListener('click',()=>{ if(requesterSigPad) requesterSigPad.clear(); const c=document.getElementById('requesterSignatureCanvas'); if(c) c.dataset.dataurl=''; });
  document.getElementById('reqSigSave').addEventListener('click',()=>{ const c=document.getElementById('requesterSignatureCanvas'); if(!requesterSigPad||requesterSigPad.isEmpty()){ showToast('Silakan buat tanda tangan pemohon terlebih dahulu',true); return } c.dataset.dataurl=requesterSigPad.toDataURL(); showToast('Tanda tangan disimpan'); });
  document.getElementById('submitRequestBtn').addEventListener('click', submitRequest);
  document.getElementById('filterMonth')?.addEventListener('change', ()=>renderAllRequests());
  document.getElementById('filterYear')?.addEventListener('change', ()=>renderAllRequests());
  document.getElementById('yearSelect')?.addEventListener('change', updateDocumentNumber);
  document.getElementById('submissionDate')?.addEventListener('change', updateDocumentNumber);
  updateDocumentNumber(); renderAllRequests(); renderVerifierDashboard(); renderSupervisorDashboard();
}
init();

/* expose */
window.viewRequestDetail=viewRequestDetail;
window.deleteRequest=deleteRequest;
window.openWhatsAppFor=openWhatsAppFor;

</script>
</body>
</html>
